# Phase 2: ë©”ì‹œì§€ ì‹œìŠ¤í…œ êµ¬í˜„ ì§„í–‰ ìƒí™©

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-02

## ğŸ“Š ì „ì²´ ì§„í–‰ë¥ : 100% (Phase 2.1 ì™„ë£Œ, Phase 2.1.5 ì™„ë£Œ)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ (ì™„ë£Œ)
- âœ… `reservation_message_logs` í…Œì´ë¸” ìƒì„±
- âœ… Supabase DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì™„ë£Œ
- âœ… ì¸ë±ìŠ¤ ë° êµ¬ì¡° ê²€ì¦ ì™„ë£Œ
- âœ… DB ìŠ¤í‚¤ë§ˆ ì •í•©ì„± í™•ì¸ (to_number, to_name í•„ë“œ)

### 2. ë³€ìˆ˜ ì¹˜í™˜ ìœ í‹¸ë¦¬í‹° (ì™„ë£Œ)
- âœ… `src/utils/messageTemplateParser.ts` ì‘ì„±
- âœ… 11ê°œ í…œí”Œë¦¿ ë³€ìˆ˜ ì§€ì›
  - `{{ê³ ê°ëª…}}`, `{{ê³µê°„ëª…}}`, `{{ì˜ˆì•½ë‚ ì§œ}}`, `{{ì²´í¬ì¸ì‹œê°„}}`, `{{ì²´í¬ì•„ì›ƒì‹œê°„}}`
  - `{{ì¸ì›ìˆ˜}}`, `{{ì´ê¸ˆì•¡}}`, `{{ì…ê¸ˆì•¡}}`, `{{ì”ê¸ˆ}}`, `{{ì „í™”ë²ˆí˜¸}}`, `{{íŠ¹ì´ì‚¬í•­}}`
- âœ… ë°”ì´íŠ¸ ê³„ì‚° ë° SMS/LMS ìë™ íŒë‹¨ ê¸°ëŠ¥
- âœ… ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ (ìƒ˜í”Œ ë°ì´í„° ì¹˜í™˜)

### 3. í…œí”Œë¦¿ CRUD API (ì™„ë£Œ)
- âœ… `GET /api/reservations/message-templates` - í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ (ì¹´í…Œê³ ë¦¬ í•„í„° ì§€ì›)
- âœ… `POST /api/reservations/message-templates` - í…œí”Œë¦¿ ìƒì„±
- âœ… `GET /api/reservations/message-templates/[id]` - í…œí”Œë¦¿ ìƒì„¸ ì¡°íšŒ
- âœ… `PUT /api/reservations/message-templates/[id]` - í…œí”Œë¦¿ ìˆ˜ì •
- âœ… `DELETE /api/reservations/message-templates/[id]` - í…œí”Œë¦¿ ì‚­ì œ

**êµ¬í˜„ëœ ê¸°ëŠ¥:**
- JWT ì¸ì¦ ê¸°ë°˜ ì‚¬ìš©ì ê¶Œí•œ ì²´í¬
- ì†Œìœ ì ê²€ì¦ (user_id ë§¤ì¹­)
- ì…ë ¥ ë°ì´í„° ê²€ì¦ (ì´ë¦„ 100ì, ë‚´ìš© 2000ì ì œí•œ)
- Next.js 15 Promise params í˜¸í™˜ì„±

### 4. í…œí”Œë¦¿ UI ì—°ë™ (ì™„ë£Œ)
- âœ… `/reservations/message/templates` í˜ì´ì§€ API ì—°ë™
- âœ… í…œí”Œë¦¿ ìƒì„± ëª¨ë‹¬ (ë³€ìˆ˜ ì•ˆë‚´ í¬í•¨)
- âœ… í…œí”Œë¦¿ ìˆ˜ì • ëª¨ë‹¬ (ê¸°ì¡´ ë°ì´í„° ë¡œë“œ)
- âœ… í…œí”Œë¦¿ ì‚­ì œ ê¸°ëŠ¥ (í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸)
- âœ… ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° (ë³€ìˆ˜ ì¹˜í™˜ í‘œì‹œ)
- âœ… ê¸€ì ìˆ˜ ì¹´ìš´í„° (ì´ë¦„/ë‚´ìš©)
- âœ… ì¹´í…Œê³ ë¦¬ ì„ íƒ (6ê°œ ì¹´í…Œê³ ë¦¬)

### 5. ë©”ì‹œì§€ ë°œì†¡ API êµ¬í˜„ (ì™„ë£Œ)
- âœ… `POST /api/reservations/send-message` ì—”ë“œí¬ì¸íŠ¸
- âœ… ì˜ˆì•½ ë°ì´í„° ì¡°íšŒ (JOIN spaces)
- âœ… í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜ í†µí•©
- âœ… Naver SENS API í˜¸ì¶œ ì—°ë™
- âœ… **ê´‘ê³ ë¨¸ë‹ˆ ì°¨ê° ë¡œì§ ì—°ë™** (transactions ê¸°ë°˜)
  - transactions í…Œì´ë¸” ì¡°íšŒí•˜ì—¬ ê´‘ê³ ë¨¸ë‹ˆ ì”ì•¡ ê³„ì‚°
  - type: 'usage', metadata.transactionType: 'advertising'ìœ¼ë¡œ ì‚¬ìš© ê¸°ë¡
  - ê¸°ì¡´ credit_balance ì»¬ëŸ¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- âœ… `reservation_message_logs` í…Œì´ë¸”ì— ë°œì†¡ ì´ë ¥ ì €ì¥
- âœ… ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡¤ë°± ì²˜ë¦¬
- âœ… DB ìŠ¤í‚¤ë§ˆ ì •í•©ì„± ìˆ˜ì • (to_number, to_name ì‚¬ìš©)

**API ìŠ¤í™:**
```typescript
POST /api/reservations/send-message
Body: {
  reservationId: number,
  templateId?: number,     // ì„ íƒì‚¬í•­
  message: string,         // ìµœì¢… ë©”ì‹œì§€ ë‚´ìš©
  sendType?: 'immediate' | 'scheduled',
  scheduledAt?: string     // ISO 8601 format
}

Response: {
  success: boolean,
  messageId?: string,
  logId?: number,
  messageType?: 'SMS' | 'LMS',
  creditUsed?: number,
  error?: string
}
```

### 6. ë©”ì‹œì§€ ë°œì†¡ UI ì—°ë™ (ì™„ë£Œ)
- âœ… `/reservations/message/send` í˜ì´ì§€ ì™„ì„±
  - âœ… "ì˜ˆì•½ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí•˜ê¸°" ëª¨ë‹¬ êµ¬í˜„
  - âœ… "ë‚´ í…œí”Œë¦¿ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°" ë“œë¡­ë‹¤ìš´ ì—°ë™
  - âœ… "ìë™ ë¬¸êµ¬ ë„£ê¸°" ë³€ìˆ˜ ì‚½ì… ë²„íŠ¼
  - âœ… ë°”ì´íŠ¸ ìˆ˜ ê³„ì‚° í‘œì‹œ (SMS/LMS êµ¬ë¶„)
  - âœ… ë°œì†¡ API ì—°ê²°
  - âœ… ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ í”¼ë“œë°±
  - âœ… ì¦‰ì‹œ ë°œì†¡ / ì˜ˆì•½ ë°œì†¡ UI

- âœ… `/reservations/detail` í˜ì´ì§€ ìˆ˜ì •
  - âœ… "ë©”ì‹œì§€ ë³´ë‚´ê¸°" ë²„íŠ¼ ì¶”ê°€
  - âœ… `/message/send?reservationId={id}` ì´ë™ ì—°ë™
  - âœ… URL íŒŒë¼ë¯¸í„°ë¡œ ì˜ˆì•½ ìë™ ì„ íƒ (useEffect + useSearchParams)

### 7. ì˜ˆì•½ ë°œì†¡ ì‹œìŠ¤í…œ êµ¬í˜„ (ì™„ë£Œ) - Phase 2.1.5
- âœ… `reservation_scheduled_messages` í…Œì´ë¸” í™œìš©
- âœ… ì˜ˆì•½ ë°œì†¡ UI êµ¬í˜„
  - âœ… ìº˜ë¦°ë” ë°©ì‹ ë‚ ì§œ ì„ íƒ (ë“œë¡­ë‹¤ìš´ â†’ ìº˜ë¦°ë”)
  - âœ… ì‹œê°„ ì„ íƒ ë“œë¡­ë‹¤ìš´ (ì‹œ/ë¶„)
  - âœ… ì¦‰ì‹œ ë°œì†¡ / ì˜ˆì•½ ë°œì†¡ ë¼ë””ì˜¤ ë²„íŠ¼
- âœ… ì˜ˆì•½ ë°œì†¡ API ìˆ˜ì • (`POST /api/reservations/send-message`)
  - âœ… `sendType: 'scheduled'` ì²˜ë¦¬
  - âœ… `reservation_scheduled_messages` í…Œì´ë¸”ì— INSERT
  - âœ… ë¡œì»¬ íƒ€ì„ì¡´ ì²˜ë¦¬ (UTC ë³€í™˜ ì´ìŠˆ í•´ê²°)
- âœ… Vercel Cron Job êµ¬í˜„
  - âœ… `vercel.json` ìƒì„± (ë§¤ ë¶„ë§ˆë‹¤ ì‹¤í–‰)
  - âœ… `GET /api/cron/send-scheduled-messages` ì—”ë“œí¬ì¸íŠ¸
  - âœ… ì˜ˆì•½ ì‹œê°„ ë„ë˜í•œ ë©”ì‹œì§€ ìë™ ë°œì†¡
  - âœ… ê´‘ê³ ë¨¸ë‹ˆ ì°¨ê° (ë°œì†¡ ì‹œì ì— transactions ê¸°ë¡)
  - âœ… `reservation_message_logs` ë°œì†¡ ì´ë ¥ ê¸°ë¡
  - âœ… CRON_SECRET í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ì„¤ì •
  - âœ… ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ (curl ìˆ˜ë™ ì‹¤í–‰)
  - âœ… TypeScript íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì • (transaction.amount unknown í•´ê²°)

**Cron Job ì£¼ì˜ì‚¬í•­:**
- Vercel Cronì€ ë°°í¬ í™˜ê²½ì—ì„œë§Œ ìë™ ì‹¤í–‰
- ë¡œì»¬ ê°œë°œ í™˜ê²½ì—ì„œëŠ” ìˆ˜ë™ API í˜¸ì¶œë¡œ í…ŒìŠ¤íŠ¸ í•„ìš”
- ë§¤ ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ë©° `status: 'pending'`ì´ê³  `scheduled_at <= í˜„ì¬ì‹œê°„`ì¸ ë©”ì‹œì§€ ì²˜ë¦¬

---

## ğŸ“ ìƒì„±/ìˆ˜ì •ëœ íŒŒì¼

### ë°±ì—”ë“œ
```
src/
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ messageTemplateParser.ts              âœ… ì™„ë£Œ (273 lines)
â””â”€â”€ app/
    â””â”€â”€ api/
        â”œâ”€â”€ reservations/
        â”‚   â”œâ”€â”€ message-templates/
        â”‚   â”‚   â”œâ”€â”€ route.ts                   âœ… ì™„ë£Œ (GET, POST)
        â”‚   â”‚   â””â”€â”€ [id]/
        â”‚   â”‚       â””â”€â”€ route.ts               âœ… ì™„ë£Œ (GET, PUT, DELETE)
        â”‚   â””â”€â”€ send-message/
        â”‚       â””â”€â”€ route.ts                   âœ… ì™„ë£Œ (POST - ë©”ì‹œì§€ ë°œì†¡, ì¦‰ì‹œ/ì˜ˆì•½)
        â””â”€â”€ cron/
            â””â”€â”€ send-scheduled-messages/
                â””â”€â”€ route.ts                   âœ… ì™„ë£Œ (GET - Cron Job)
```

### ë°ì´í„°ë² ì´ìŠ¤
```
migrations/
â”œâ”€â”€ 20251001_add_reservation_message_logs.sql    âœ… ì™„ë£Œ (ì‹¤í–‰ë¨)
â”œâ”€â”€ 20251001_add_reservation_auto_messages.sql   âœ… ì¤€ë¹„ (Phase 2.2ìš©)
â””â”€â”€ README_PHASE2_MIGRATIONS.md                  âœ… ì™„ë£Œ
```

### í”„ë¡ íŠ¸ì—”ë“œ
```
src/app/reservations/
â”œâ”€â”€ message/
â”‚   â”œâ”€â”€ templates/page.tsx         âœ… ì™„ë£Œ (API ì—°ë™, 622 lines)
â”‚   â””â”€â”€ send/page.tsx              âœ… ì™„ë£Œ (ë©”ì‹œì§€ ë°œì†¡ UI, URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬)
â””â”€â”€ detail/page.tsx                âœ… ìˆ˜ì • (ë©”ì‹œì§€ ë²„íŠ¼ ì¶”ê°€)
```

---

## ğŸ‰ Phase 2.1 + 2.1.5 ì™„ë£Œ!

### âœ¨ ì™„ì„±ëœ ê¸°ëŠ¥

1. **í…œí”Œë¦¿ ìƒì„±** - ë³€ìˆ˜ ì•ˆë‚´ì™€ ë¯¸ë¦¬ë³´ê¸° í¬í•¨
2. **í…œí”Œë¦¿ ìˆ˜ì •** - ê¸°ì¡´ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ë° ìˆ˜ì •
3. **í…œí”Œë¦¿ ì‚­ì œ** - í™•ì¸ í›„ ì‚­ì œ
4. **í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°** - ìƒ˜í”Œ ë°ì´í„°ë¡œ ë³€ìˆ˜ ì¹˜í™˜ í™•ì¸
5. **ì¹´í…Œê³ ë¦¬ í•„í„°ë§** - 6ê°œ ì¹´í…Œê³ ë¦¬ ì§€ì›
6. **ë³€ìˆ˜ ì¹˜í™˜ ì—”ì§„** - 11ê°œ ì˜ˆì•½ ê´€ë ¨ ë³€ìˆ˜ ìë™ ì¹˜í™˜
7. **ë©”ì‹œì§€ íƒ€ì… ìë™ íŒë‹¨** - ë°”ì´íŠ¸ ê³„ì‚°ìœ¼ë¡œ SMS/LMS ì„ íƒ
8. **ë©”ì‹œì§€ ë°œì†¡** - ì¦‰ì‹œ/ì˜ˆì•½ ë°œì†¡ ì§€ì›
9. **ê´‘ê³ ë¨¸ë‹ˆ ì—°ë™** - transactions ê¸°ë°˜ ì”ì•¡ ê´€ë¦¬
10. **ì˜ˆì•½ ìƒì„¸ í˜ì´ì§€ ì—°ë™** - ì›í´ë¦­ ë©”ì‹œì§€ ë°œì†¡
11. **ì˜ˆì•½ ë°œì†¡ ì‹œìŠ¤í…œ** - ìº˜ë¦°ë” ë‚ ì§œ ì„ íƒ, ì‹œê°„ ì˜ˆì•½, Cron Job ìë™ ë°œì†¡
12. **ì „í™”ë²ˆí˜¸ ë³€ìˆ˜ ìˆ˜ì •** - {{ì „í™”ë²ˆí˜¸}}ê°€ í˜¸ìŠ¤íŠ¸ íšŒì‹  ë²ˆí˜¸ë¡œ ì¹˜í™˜

---

## ğŸ“‹ ë‹¤ìŒ ë‹¨ê³„: Phase 2.2 (ë³´ë‚¸ ë©”ì‹œì§€ & ìë™ ë©”ì‹œì§€)

### ë‚¨ì€ ì‘ì—… (ì˜ˆìƒ 13-18ì‹œê°„)

1. **ë³´ë‚¸ ë©”ì‹œì§€ ëª©ë¡ API** (2-3ì‹œê°„)
   - [ ] GET /api/reservations/message-logs
   - [ ] GET /api/reservations/message-logs/[id]
   - [ ] í•„í„°ë§ ë° ê²€ìƒ‰ ê¸°ëŠ¥

2. **ë³´ë‚¸ ë©”ì‹œì§€ í˜ì´ì§€ ì—°ë™** (2-3ì‹œê°„)
   - [ ] /message/list í˜ì´ì§€ ì—°ë™
   - [ ] /message/list/reserved í˜ì´ì§€ ì—°ë™ (ë°œì†¡ ì˜ˆì •)

3. **ìë™ ê·œì¹™ CRUD API** (3-4ì‹œê°„)
   - [ ] reservation_auto_message_rules í…Œì´ë¸” ìƒì„±
   - [ ] GET /api/reservations/auto-rules
   - [ ] POST /api/reservations/auto-rules
   - [ ] PUT /api/reservations/auto-rules/[id]
   - [ ] DELETE /api/reservations/auto-rules/[id]

4. **ìë™ ë©”ì‹œì§€ í˜ì´ì§€ ì—°ë™** (2-3ì‹œê°„)
   - [ ] /message/auto í˜ì´ì§€ ì—°ë™
   - [ ] /message/auto/create í˜ì´ì§€ ì—°ë™

5. **ìë™ ë°œì†¡ Cron Job** (4-5ì‹œê°„)
   - [ ] GET /api/reservations/auto-send-check
   - [ ] ë°œì†¡ ì‹œê°„ ê³„ì‚° ë¡œì§
   - [ ] ì¤‘ë³µ ë°œì†¡ ë°©ì§€
   - [ ] Vercel Cron ì„¤ì •

---

## ğŸ“ ì£¼ìš” ë³€ê²½ì‚¬í•­ (2025-10-02)

### ê´‘ê³ ë¨¸ë‹ˆ ì‹œìŠ¤í…œ í†µí•©
- âœ… ê¸°ì¡´ `users.credit_balance` ì»¬ëŸ¼ ì‚¬ìš© ì¤‘ì§€
- âœ… `transactions` í…Œì´ë¸” ê¸°ë°˜ ì”ì•¡ ê³„ì‚°
- âœ… target-marketing ìº í˜ì¸ê³¼ ë™ì¼í•œ ë¡œì§ ì ìš©
- âœ… ë©”ì‹œì§€ ë°œì†¡ ì‹œ `type: 'usage'` íŠ¸ëœì­ì…˜ ìƒì„±

### DB ìŠ¤í‚¤ë§ˆ ì •í•©ì„± ìˆ˜ì •
- âœ… `recipient_phone` â†’ `to_number`
- âœ… `recipient_name` â†’ `to_name`
- âœ… ë¶ˆí•„ìš”í•œ í•„ë“œ ì œê±° (send_type, scheduled_at, sens_request_id, message_bytes, credit_used)

---

**ë¬¸ì„œ ë²„ì „**: 2.0
**ì‘ì„±ì**: MTS Message ê°œë°œíŒ€
**Phase 2.1 ì™„ë£Œì¼**: 2025-10-02

# MTS API 통합 테스트 가이드

> **프로젝트**: MTS Message Portal
> **작성일**: 2025-10-29
> **최종 업데이트**: 2025-10-30
> **버전**: v1.2
> **목적**: MTS API 전환 후 전체 기능 통합 테스트 가이드
> **대상**: QA 팀, 개발자, 프로젝트 관리자

---

## 🚨 현재 테스트 현황 (2025-10-30)

### ✅ 완료된 테스트
- **Phase 3.0**: 알림톡 템플릿 등록 및 검수 요청 (16/16 항목) ✅
- **Phase 3.1**: 알림톡 발송 - 템플릿 변수 치환 (15/20 항목) ⚠️
  - UI 테스트: 완료 (15개 항목)
  - MTS API 호출: 성공 (응답 코드 `0000`)
  - **⚠️ 이슈**: 실제 알림톡 수신 안됨, 로그 미생성, 잔액 차감 안됨 (5개 항목 실패)

### ⏸️ 대기 중인 항목
1. **MTS 측 발신번호 등록 API 대기**
   - 현재 발신번호 등록 API 미제공 상태
   - MTS 측 API 제공 시 테스트 진행 예정

2. **네이버 톡톡 계정 필요**
   - Phase 5 테스트를 위한 네이버 톡톡 계정 준비 필요

### 🔧 알려진 이슈
1. **알림톡 발송 이슈 (Phase 3.1)**
   - **증상**: MTS API 호출 성공하나 실제 카카오톡 수신 안됨
   - **MTS API 응답**: `code: '0000'` (성공)
   - **영향**:
     - `message_logs` 테이블에 로그 미생성
     - 사용자 잔액 (광고머니) 차감 안됨
   - **추정 원인**:
     - MTS 측 알림톡 발송 설정 미완료 가능성
     - 발신프로필 또는 템플릿 승인 상태 확인 필요
     - MTS API 테스트 환경 설정 확인 필요
   - **다음 조치**: MTS 측 확인 요청

### 📝 추후 구현 예정
- **알림톡 예약 발송 기능**
  - 현재: "발송" 버튼만 존재
  - 계획: 예약 로직 구현 후 "전송/예약 준비" 버튼으로 통합

---

## 📋 목차

1. [현재 테스트 현황](#현재-테스트-현황-2025-10-30)
2. [테스트 개요](#테스트-개요)
3. [테스트 진행 방법](#테스트-진행-방법)
4. [테스트 환경 설정](#테스트-환경-설정)
5. [Phase 1: SMS/LMS/MMS 즉시 발송 테스트](#phase-1-smslmsmms-즉시-발송-테스트)
6. [Phase 2: SMS/LMS/MMS 예약 발송 테스트](#phase-2-smslmsmms-예약-발송-테스트)
7. [Phase 3: 카카오 알림톡 테스트](#phase-3-카카오-알림톡-테스트)
8. [Phase 4: 카카오 친구톡 V2 테스트](#phase-4-카카오-친구톡-v2-테스트)
9. [Phase 5: 네이버 톡톡 테스트](#phase-5-네이버-톡톡-테스트)
10. [Phase 6: 카카오 브랜드 메시지 테스트](#phase-6-카카오-브랜드-메시지-테스트)
11. [Phase 7: 시스템 알림 테스트](#phase-7-시스템-알림-테스트)
12. [Phase 8: Cron Job 예약 발송 테스트](#phase-8-cron-job-예약-발송-테스트)
13. [에러 핸들링 테스트](#에러-핸들링-테스트)
14. [성능 테스트](#성능-테스트)
15. [최종 체크리스트](#최종-체크리스트)

---

## 테스트 개요

### 테스트 목적

- Naver SENS API → MTS API 전환 후 모든 메시지 발송 기능의 정상 작동 확인
- 각 메시지 타입별 발송 성공률 검증
- 에러 핸들링 및 전환 발송 기능 검증
- 예약 발송 및 Cron Job 동작 확인
- 시스템 안정성 및 성능 검증

### 테스트 범위

| 구분 | 포함 항목 | 우선순위 |
|------|----------|---------|
| **기본 발송** | SMS, LMS, MMS 즉시/예약 발송 | ⭐⭐⭐ 필수 |
| **카카오톡** | 알림톡, 친구톡 V2, 브랜드 메시지 | ⭐⭐⭐ 필수 |
| **네이버** | 톡톡 스마트알림 | ⭐⭐ 중요 |
| **시스템 알림** | 사업자 인증, 문의 답변, 회원 승인 | ⭐⭐ 중요 |
| **자동화** | Cron Job, 예약 발송 | ⭐⭐⭐ 필수 |
| **에러 처리** | 에러 코드별 핸들링 | ⭐⭐ 중요 |
| **성능** | 다중 발송, 동시성 | ⭐ 선택 |

### 테스트 제외 항목

- ❌ RCS 메시지 (기능 제거됨)
- ❌ Naver SENS API (완전 제거됨)
- ❌ 결제 시스템 (메시지 발송과 무관)
- ❌ UI/UX 디자인 검증 (별도 진행)

---

## 🔄 테스트 진행 방법

### 단계별 진행 프로세스

본 테스트는 **Phase 단위로 순차 진행**합니다. 각 Phase는 독립적으로 완료 가능하며, 이전 Phase 완료 후 다음 Phase로 진행합니다.

#### 1단계: Phase 시작
```
요청: "Phase 1 테스트 내용 알려줘"
```
- 해당 Phase의 모든 테스트 항목 확인
- Phase별 체크리스트 검토
- 사전 조건 충족 여부 확인

#### 2단계: 사전 검증
- 테스트 항목 검토 중 잘못 구현된 부분 발견 시:
  ```
  피드백: "이 부분은 이렇게 구현되어야해"
  ```
- 코드 수정 후 다음 단계 진행

#### 3단계: 테스트 실행
- 실제 환경에서 각 테스트 시나리오 수행
- 예상 결과와 실제 결과 비교
- 발생한 이슈 기록

#### 4단계: 결과 보고
```
보고: "시나리오 1.1 성공, 시나리오 1.2 실패 (에러: xxx)"
```
- 성공/실패 여부 명확히 전달
- 실패 시 에러 메시지 또는 증상 상세 설명
- 스크린샷이나 로그 있으면 함께 제공

#### 5단계: 문서 업데이트
- 테스트 결과 반영
- 발견된 버그 수정
- 체크리스트 완료 표시
- 다음 Phase 준비

### Phase 완료 기준

각 Phase는 다음 조건을 모두 만족해야 완료:
- ✅ 모든 테스트 시나리오 실행 완료
- ✅ 필수 항목 100% 성공
- ✅ 발견된 버그 수정 또는 이슈 트래킹 등록
- ✅ Phase별 체크리스트 모두 체크

### 테스트 우선순위

| 우선순위 | 설명 | 실패 시 조치 |
|---------|------|------------|
| ⭐⭐⭐ 필수 | 반드시 통과해야 함 | 즉시 수정 후 재테스트 |
| ⭐⭐ 중요 | 가능한 통과 권장 | 이슈 등록 후 다음 Phase 진행 가능 |
| ⭐ 선택 | 시간 여유 시 진행 | 나중에 재테스트 가능 |

---

## 테스트 환경 설정

### 1. 필수 환경 변수 확인

```bash
# .env 파일 확인
MTS_AUTH_CODE=xxx          # MTS 인증 코드 (필수)
MTS_API_URL=https://api.mtsco.co.kr
MTS_TEMPLATE_API_URL=https://talks.mtsco.co.kr
TEST_CALLING_NUMBER=010XXXXXXXX  # 테스트 발신번호
NEXT_PUBLIC_SUPABASE_URL=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
JWT_SECRET=xxx
```

**확인 방법:**
```bash
# 환경 변수 확인
grep -E "MTS_AUTH_CODE|MTS_API_URL" .env
```

### 2. 데이터베이스 준비

**테스트 데이터 준비:**

```sql
-- 1. 테스트 사용자 계정 확인
SELECT id, username, email, phone_number, role
FROM users
WHERE email LIKE '%test%';

-- 2. 테스트 발신번호 등록 확인
SELECT * FROM sender_numbers
WHERE phone_number = '테스트_발신번호';

-- 3. 기존 예약 메시지 확인
SELECT COUNT(*) FROM scheduled_messages
WHERE status = 'pending';
```

### 3. 테스트 수신번호 준비

| 용도 | 전화번호 | 비고 |
|------|---------|------|
| 성공 케이스 | 010-XXXX-XXXX | 실제 수신 가능 번호 |
| 실패 케이스 | 010-0000-0000 | 결번 (에러 1013) |
| 차단 케이스 | 010-1111-1111 | 착신거절 (에러 6014) |

### 4. 카카오/네이버 계정 준비

**카카오톡:**
- 발신프로필 키 (sender_key) 준비
- 알림톡 템플릿 최소 1개 승인 완료 상태
- 친구톡 채널 활성화 상태

**네이버 톡톡:**
- 네이버톡 ID (navertalk_id) 준비
- 템플릿 최소 1개 등록 완료

### 5. 테스트 도구 설치

```bash
# 개발 서버 실행
npm run dev

# 별도 터미널에서 로그 모니터링
tail -f .next/server/app/api/messages/send/route.log
```

---

## Phase 1: SMS/LMS/MMS 즉시 발송 테스트

### 📌 사전 조건

- ✅ 테스트 발신번호가 `sender_numbers` 테이블에 등록됨
- ✅ 사용자 계정의 잔액이 충분함 (최소 1,000원)
- ✅ MTS_AUTH_CODE가 유효함

### 📋 Phase 1 테스트 체크리스트

#### ✅ 1.1 SMS 즉시 발송 (단건)
- [ ] 발신번호 선택 가능
- [ ] 수신번호 입력 정상 (010-XXXX-XXXX)
- [ ] 90바이트 이하 메시지 입력 (한글 45자 이하)
- [ ] 발송 버튼 클릭 성공
- [ ] HTTP 응답 200 OK 확인
- [ ] MTS 응답 코드 0000 확인
- [ ] msg_id (20자리) 반환 확인
- [ ] 1분 이내 실제 휴대폰 수신 확인
- [ ] 잔액 20원 차감 확인
- [ ] message_logs 테이블 저장 확인
- [ ] transactions 테이블 기록 확인

#### ✅ 1.2 LMS 즉시 발송 (장문)
- [ ] 90바이트 초과 메시지 입력 (한글 100자)
- [ ] 제목 입력 (선택 사항)
- [ ] 발송 버튼 클릭 성공
- [ ] MTS 응답 코드 0000 확인
- [ ] 메시지 타입 LMS로 자동 판단 확인
- [ ] 잔액 50원 차감 확인
- [ ] 수신 시 제목 표시 확인
- [ ] message_logs에 subject 저장 확인

#### ✅ 1.3 MMS 즉시 발송 (이미지 포함)
- [ ] 메시지 내용 입력
- [ ] 제목 입력
- [ ] 이미지 파일 업로드 (JPG/PNG, 300KB 이하)
- [ ] 이미지 미리보기 표시 확인
- [ ] 발송 버튼 클릭 성공
- [ ] MTS 응답 코드 0000 확인
- [ ] 메시지 타입 MMS로 판단 확인
- [ ] 잔액 200원 차감 확인
- [ ] 수신 시 이미지 정상 표시 확인
- [ ] metadata에 image_urls 저장 확인

#### ✅ 1.4 다중 수신자 발송 (SMS)
- [ ] 수신번호 3개 이상 입력 (쉼표 구분)
- [ ] 메시지 내용 입력 (90바이트 이하)
- [ ] 발송 버튼 클릭 성공
- [ ] 각 수신번호별 MTS API 호출 확인
- [ ] 모든 수신번호 응답 코드 0000 확인
- [ ] 잔액 (수신자수 × 20원) 차감 확인
- [ ] message_logs에 수신자별 레코드 생성 확인
- [ ] 실패한 번호 별도 표시 확인 (있을 경우)

---

### 테스트 시나리오 1.1: SMS 즉시 발송 (단건)

**목적**: 90바이트 이하 문자 발송 성공 확인

**테스트 단계:**

1. 메시지 발송 페이지 접속 (`/messages/send`)
2. 발신번호 선택
3. 수신번호 입력: `010-XXXX-XXXX`
4. 메시지 내용 입력 (한글 45자 이하):
   ```
   [테스트] MTS API 전환 후 SMS 발송 테스트입니다.
   ```
5. "발송" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 | 확인 방법 |
|------|--------|----------|
| HTTP 응답 코드 | 200 OK | 브라우저 개발자 도구 |
| MTS 응답 코드 | `0000` | API 응답 JSON |
| msg_id | 20자리 숫자 | API 응답 JSON |
| 메시지 수신 | 1분 이내 수신 | 실제 휴대폰 확인 |
| DB 저장 | `message_logs` 테이블 삽입 | SQL 조회 |
| 잔액 차감 | -20원 | `users.balance` 확인 |
| 트랜잭션 기록 | `transactions` 테이블 삽입 | SQL 조회 |

**DB 확인 쿼리:**
```sql
-- 발송 로그 확인
SELECT * FROM message_logs
WHERE created_at > NOW() - INTERVAL '5 minutes'
ORDER BY created_at DESC
LIMIT 5;

-- 트랜잭션 확인
SELECT * FROM transactions
WHERE created_at > NOW() - INTERVAL '5 minutes'
AND transaction_type = 'message_send'
ORDER BY created_at DESC;
```

**성공 기준:**
- ✅ MTS API 응답 코드 `0000`
- ✅ 1분 이내 실제 휴대폰에 메시지 수신
- ✅ 잔액 20원 차감
- ✅ `message_logs` 테이블에 기록 저장

**실패 시 조치:**
- MTS 응답 코드 확인 (`code` 필드)
- 에러 메시지 확인 (`message` 필드)
- [에러 핸들링 테스트](#에러-핸들링-테스트) 섹션 참고

---

### 테스트 시나리오 1.2: LMS 즉시 발송 (장문)

**목적**: 90바이트 초과 장문 메시지 발송 확인

**테스트 단계:**

1. 메시지 발송 페이지 접속
2. 발신번호 선택
3. 수신번호 입력
4. 메시지 내용 입력 (한글 100자):
   ```
   [테스트] MTS API 전환 후 LMS 발송 테스트입니다.
   90바이트를 초과하는 장문 메시지는 자동으로 LMS로 발송됩니다.
   이 메시지는 정확히 100자로 작성되었습니다.
   ```
5. 제목 입력 (선택): `LMS 테스트 제목`
6. "발송" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `0000` |
| 메시지 타입 | LMS (장문) |
| 잔액 차감 | -50원 |
| 제목 포함 여부 | 제목 표시됨 |

**성공 기준:**
- ✅ LMS 형식으로 발송 (제목 + 본문)
- ✅ 잔액 50원 차감
- ✅ 메시지 전체 내용 수신

---

### 테스트 시나리오 1.3: MMS 즉시 발송 (이미지 포함)

**목적**: 이미지 첨부 MMS 발송 확인

**사전 조건:**
- ✅ 이미지 파일 준비 (JPEG/PNG, 최대 300KB)

**테스트 단계:**

1. 메시지 발송 페이지 접속
2. 발신번호 선택
3. 수신번호 입력
4. 제목 입력: `MMS 테스트`
5. 메시지 내용 입력:
   ```
   [테스트] MMS 이미지 발송 테스트입니다.
   ```
6. 이미지 파일 첨부 (업로드)
7. "발송" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 이미지 업로드 API | `/img/upload_image` 호출 성공 |
| 이미지 경로 | `/2025/01/29/xxxx.jpg` 형식 |
| MTS 응답 코드 | `0000` |
| 잔액 차감 | -200원 |
| 이미지 수신 | 실제 이미지 표시됨 |

**성공 기준:**
- ✅ 이미지 업로드 성공
- ✅ MMS 형식으로 발송
- ✅ 잔액 200원 차감
- ✅ 이미지 정상 수신

---

### 테스트 시나리오 1.4: 다중 수신자 발송

**목적**: 여러 수신자에게 동시 발송 확인

**테스트 단계:**

1. 메시지 발송 페이지 접속
2. 발신번호 선택
3. 수신번호 입력 (3개):
   ```
   010-XXXX-1111
   010-XXXX-2222
   010-XXXX-3333
   ```
4. 메시지 내용 입력:
   ```
   [테스트] 다중 수신자 발송 테스트
   ```
5. "발송" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 호출 횟수 | 3회 (각 수신자별) |
| 성공 건수 | 3건 |
| 실패 건수 | 0건 |
| 잔액 차감 | -60원 (20원 × 3) |
| DB 레코드 | 3개 행 삽입 |

**성공 기준:**
- ✅ 모든 수신자에게 발송 성공
- ✅ 각 발송마다 별도 msg_id 생성
- ✅ 총 잔액 차감 = 수신자 수 × 단가

---

## Phase 2: SMS/LMS/MMS 예약 발송 테스트

### 📌 사전 조건

- ✅ Phase 1 즉시 발송 테스트 통과
- ✅ Cron Job 설정 확인 (`/api/messages/scheduled-send-check`)

### 📋 Phase 2 테스트 체크리스트

#### ✅ 2.1 SMS 예약 발송 (5분 후)
- [ ] "예약 발송" 옵션 선택 가능
- [ ] 예약 시간 설정 UI 정상 (현재 + 5분)
- [ ] 발신/수신번호, 메시지 입력
- [ ] "예약 등록" 버튼 클릭 성공
- [ ] scheduled_messages 테이블 즉시 삽입 확인
- [ ] status = 'pending' 확인
- [ ] scheduled_at 값 정확한지 확인
- [ ] 예약 직후 잔액 차감 없음 확인
- [ ] 5분 대기 후 실제 발송 확인
- [ ] status = 'sent' 변경 확인
- [ ] sent_at 시간 기록 확인
- [ ] 발송 시점에 잔액 20원 차감 확인
- [ ] message_logs 테이블 기록 확인
- [ ] 예약 시간 ±1분 이내 발송 확인

#### ✅ 2.2 예약 발송 취소
- [ ] 예약 메시지 등록 (10분 후)
- [ ] 예약 목록 페이지 접속 (/messages/reservations/list)
- [ ] 등록한 예약 메시지 표시 확인
- [ ] "취소" 버튼 표시 확인
- [ ] "취소" 버튼 클릭
- [ ] 확인 모달 표시 확인
- [ ] 모달에서 "확인" 클릭
- [ ] status = 'cancelled' 변경 확인
- [ ] 예약 시간 도달해도 발송 안됨 확인
- [ ] 잔액 차감 없음 확인
- [ ] Cron Job에서 해당 메시지 스킵 확인

---

### 테스트 시나리오 2.1: SMS 예약 발송 (5분 후)

**목적**: 예약 시간에 정확히 발송되는지 확인

**테스트 단계:**

1. 메시지 발송 페이지 접속
2. "예약 발송" 옵션 선택
3. 예약 시간 설정: **현재 시각 + 5분**
4. 발신번호, 수신번호 입력
5. 메시지 내용 입력:
   ```
   [예약 테스트] 5분 후 발송 예정 메시지
   ```
6. "예약 등록" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 | 확인 시점 |
|------|--------|----------|
| DB 저장 | `scheduled_messages` 테이블 삽입 | 즉시 |
| status | `pending` | 즉시 |
| scheduled_at | 설정한 예약 시간 | 즉시 |
| 잔액 차감 | 차감 없음 (예약만) | 즉시 |
| Cron Job 실행 | 1분마다 체크 | 대기 중 |
| 실제 발송 | MTS API 호출 | 예약 시간 도달 |
| status 변경 | `sent` | 발송 후 |
| 잔액 차감 | -20원 | 발송 후 |

**DB 확인 쿼리:**
```sql
-- 예약 메시지 확인
SELECT id, to_number, message_content, scheduled_at, status, sent_at
FROM scheduled_messages
WHERE created_at > NOW() - INTERVAL '10 minutes'
ORDER BY created_at DESC;

-- 5분 후 다시 확인
SELECT id, status, sent_at, mts_msg_id
FROM scheduled_messages
WHERE id = '위에서_확인한_ID';
```

**성공 기준:**
- ✅ 예약 등록 즉시 `scheduled_messages` 테이블에 저장
- ✅ 예약 시간 도달 시 ±1분 이내 발송
- ✅ status가 `pending` → `sent`로 변경
- ✅ 실제 메시지 수신 확인

**실패 시 조치:**
1. Cron Job 로그 확인:
   ```bash
   tail -f .next/server/app/api/messages/scheduled-send-check/route.log
   ```
2. 예약 시간 형식 확인 (YYYYMMDDHHmmss)
3. 발신번호 존재 여부 확인

---

### 테스트 시나리오 2.2: 예약 발송 취소

**목적**: 예약된 메시지를 발송 전에 취소 가능한지 확인

**테스트 단계:**

1. 예약 메시지 등록 (10분 후 발송 예정)
2. 예약 메시지 목록 페이지 접속 (`/messages/reservations/list`)
3. 방금 등록한 예약 메시지 찾기
4. "취소" 버튼 클릭
5. 확인 모달에서 "확인" 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| status 변경 | `pending` → `cancelled` |
| Cron Job 처리 | 해당 메시지 스킵 |
| 실제 발송 | 발송 안됨 |
| 잔액 차감 | 없음 |

**성공 기준:**
- ✅ status가 `cancelled`로 변경
- ✅ 예약 시간이 지나도 발송되지 않음
- ✅ 잔액 차감 없음

---

## Phase 3: 카카오 알림톡 테스트

### 📌 사전 조건

- ✅ **카카오 발신프로필이 DB에 등록되어 있음** (`kakao_sender_profiles` 테이블)
  - 카카오톡 채널 개설 후 토큰 발급 받기
  - `/api/kakao/sender/register` API로 발신프로필 등록
  - MTS에서 `sender_key` 발급 받아 DB에 자동 저장
  - `status='A'`, `block=false`, `dormant=false` 상태여야 함
- ✅ 알림톡 템플릿 최소 1개 승인 완료 (MTS 시스템에서)
- ✅ 템플릿 코드 (template_code) 확인
- ✅ 사용자 잔액 충분 (최소 100원 이상 권장)

**⚠️ 중요**:
- 발신프로필 조회는 **MTS API가 아닌 Supabase DB**에서 수행됩니다.
- 템플릿 조회는 **MTS Template API**를 사용합니다.

**사전 조건 확인 쿼리:**
```sql
-- 1. 카카오 발신프로필 확인
SELECT sender_key, yellow_id, channel_name, status, block, dormant
FROM kakao_sender_profiles
WHERE user_id = 'your_user_id'
  AND status = 'A'
  AND block = false
  AND dormant = false;

-- 2. 사용자 잔액 확인
SELECT balance FROM users WHERE id = 'your_user_id';
```

### 📋 Phase 3 테스트 체크리스트

#### ✅ 3.0 알림톡 템플릿 등록 및 검수 요청
- [x] "카카오/네이버 톡톡" 탭 선택 가능
- [x] 카카오 메인 탭 선택됨 (기본값)
- [x] "알림톡 템플릿" 서브 탭 선택 가능
- [x] 발신프로필 선택 가능
- [x] "템플릿 추가" 버튼 클릭 가능
- [x] 템플릿 추가 모달 열림
- [x] 템플릿 코드 입력 가능 (최대 30자)
- [x] 템플릿 이름 입력 가능 (최대 200자)
- [x] 템플릿 내용 입력 가능
- [x] "검수 즉시 요청" 체크박스 표시
- [x] "검수 즉시 요청" 체크 시 등록과 동시에 검수 요청
- [x] "등록" 버튼 클릭 성공
- [x] 템플릿이 DB에 저장됨 (inspection_status = 'REG' 또는 'REQ')
- [x] 검수 요청 시 MTS API 호출 성공 (코드 200)
- [x] 템플릿 목록에 새 템플릿 표시
- [x] 템플릿 상태 레이블 정확히 표시 (예: "대기 · 검수중")

#### ⚠️ 3.1 알림톡 발송 (템플릿 변수 치환) - UI 테스트 완료, 실제 발송 이슈
- [x] "카카오/네이버 톡톡" 탭 선택 가능
- [x] 카카오 메인 탭 선택됨 (기본값)
- [x] "알림톡 템플릿" 서브 탭 선택 가능
- [x] 발신프로필 드롭다운 정상 표시 (채널명 표시)
- [x] 발신프로필 선택 시 템플릿 자동 로딩 (1초 이내)
- [x] 템플릿 드롭다운에 템플릿명과 상태 표시 (예: "배송알림 (정상 · 승인됨)")
- [x] 템플릿 선택 가능
- [x] 템플릿 내용 미리보기 표시
- [x] 수신번호 입력 가능 (엔터로 여러 번호 입력)
- [x] 회신번호 드롭다운 표시 및 선택 가능
- [x] 변수 입력 필드 자동 생성 확인 (템플릿에 #{변수명} 형식이 있는 경우)
- [x] 모든 변수 값 입력 가능
- [x] "발송" 버튼 클릭 성공
- [x] MTS 응답 코드 0000 또는 1000 확인
- [x] 발송 성공 알림 표시
- [ ] ⚠️ 카카오톡 알림톡 수신 확인 (노란색 배경) - **실패: 메시지 수신 안됨**
- [ ] ⚠️ 변수 치환 정확성 확인 - **대기: 수신 후 확인 예정**
- [ ] ⚠️ 잔액 15원 차감 확인 - **실패: 차감 안됨**
- [ ] ⚠️ message_logs에 type='ALIMTALK' 저장 확인 - **실패: 로그 미생성**
- [ ] ⚠️ metadata에 sender_key, template_code 저장 확인 - **실패: 로그 미생성**

#### ✅ 3.2 알림톡 버튼 테스트
- [x] 템플릿 추가 모달에서 "버튼 추가" 버튼 표시 확인
- [x] "버튼 추가" 클릭 시 버튼 입력 폼 생성 확인
- [x] 버튼 이름 입력 필드 표시 (최대 14자)
- [x] 버튼 타입 선택 드롭다운 표시 (WL, AL, BK, MD)
- [x] WL/AL 타입 선택 시 URL 입력 필드 표시
- [x] 모바일 URL 입력 (필수)
- [x] PC URL 입력 (선택)
- [x] 버튼 삭제 아이콘 표시 및 동작 확인
- [x] 최대 5개까지 버튼 추가 가능 확인
- [x] 5개 초과 시 "버튼은 최대 5개까지 추가 가능합니다." 에러 표시
- [x] 버튼 이름 미입력 시 유효성 검사 확인
- [x] 버튼 이름 14자 초과 시 유효성 검사 확인
- [x] WL/AL 타입에서 URL 미입력 시 유효성 검사 확인
- [x] URL 형식 검사 (http:// 또는 https://)
- [x] 템플릿 등록 API 호출 시 버튼 데이터 포함 확인
- [x] DB kakao_alimtalk_templates 테이블에 buttons 필드 저장 확인
- [ ] ⚠️ MTS API로 버튼 데이터 전송 확인 - **대기: MTS 관련 로직 확인 시 검증 예정**
- [ ] ⚠️ 카카오톡 수신 메시지에 버튼 표시 확인 - **대기: 실제 발송 테스트 필요**
- [ ] ⚠️ 버튼 클릭 시 올바른 URL로 이동 확인 - **대기: 실제 발송 테스트 필요**
- [ ] ⚠️ 모바일 브라우저에서 페이지 정상 표시 확인 - **대기: 실제 발송 테스트 필요**

#### ✅ 3.3 알림톡 → SMS 전환 발송
- [ ] 전환 발송 옵션 설정 (tranType, tranMessage)
- [ ] 알림톡 친구 미등록 번호로 발송 시도
- [ ] 알림톡 발송 실패 확인 (친구 아님)
- [ ] SMS로 자동 전환 발송 확인
- [ ] 전환 메시지 내용 tranMessage와 일치 확인
- [ ] 잔액 차감: 알림톡(15원) + SMS(20원) = 35원 확인
- [ ] message_logs에 전환 발송 기록 확인
- [ ] metadata에 tranType, tranCallback, tranMessage 저장 확인

---

### 테스트 시나리오 3.0: 알림톡 템플릿 등록 및 검수 요청

**목적**: 알림톡 템플릿 등록 및 검수 요청 프로세스 확인

**사전 준비:**
- 카카오 발신프로필이 등록되어 있어야 함
- 발신프로필의 sender_key 확인

**테스트 단계:**

1. 메시지 발송 페이지 → "카카오/네이버 톡톡" 탭 선택
2. 카카오 메인 탭 선택 (기본값)
3. "알림톡 템플릿" 서브 탭 선택
4. 발신프로필 선택 (드롭다운)
5. "템플릿 추가" 버튼 클릭
6. 템플릿 추가 모달에서 정보 입력:
   - 템플릿 코드: `test_template_001` (30자 이내, 영문/숫자/언더스코어만)
   - 템플릿 이름: `테스트 템플릿` (200자 이내)
   - 템플릿 내용:
     ```
     안녕하세요 #{고객명}님,
     주문하신 상품이 #{배송상태} 상태입니다.
     송장번호: #{송장번호}
     ```
   - "검수 즉시 요청" 체크박스: ✅ 체크
7. "등록" 버튼 클릭
8. 성공 알림 확인: "템플릿이 등록되고 검수 요청되었습니다."
9. 모달 자동 닫힘
10. 템플릿 목록 새로고침

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| DB 저장 | `kakao_alimtalk_templates` 테이블에 저장됨 |
| inspection_status | `REQ` (검수 요청됨) |
| status | `R` (대기) |
| MTS API 응답 코드 | `200` (검수 요청 성공) |
| 템플릿 목록 | 새 템플릿이 "대기 · 검수중" 상태로 표시 |

**성공 기준:**
- ✅ 템플릿이 DB에 저장됨
- ✅ MTS API 검수 요청 성공 (코드 200)
- ✅ 템플릿 목록에 표시됨
- ✅ 상태 레이블이 "대기 · 검수중"으로 표시

**실패 시 조치:**
- 템플릿 코드 중복: 다른 코드 사용
- MTS API 응답 실패: sender_key 확인
- 템플릿 내용 검증 실패: 카카오 템플릿 가이드 확인

**⚠️ 중요 발견사항 (2025-10-30):**
- MTS API 문서에는 알림톡 성공 코드가 `1000`으로 명시되어 있으나, 실제로는 `0000` 반환
- 검수 요청 API는 `200` 반환
- `src/lib/mtsApi.ts`의 `sendMtsAlimtalk()` 함수에서 두 코드 모두 처리하도록 수정됨

---

### 테스트 시나리오 3.1: 알림톡 발송 (템플릿 변수 치환)

**목적**: 알림톡 템플릿 변수 치환 및 발송 성공 확인

**사전 준비:**
- 승인된 템플릿 예시:
  ```
  안녕하세요 #{고객명}님,
  주문하신 상품이 #{배송상태} 상태입니다.
  송장번호: #{송장번호}
  ```

**테스트 단계:**

1. 메시지 발송 페이지 → "카카오/네이버 톡톡" 탭 선택
2. 카카오 메인 탭 선택 (기본값)
3. "알림톡 템플릿" 서브 탭 선택
4. 발신프로필 선택 (드롭다운)
5. 템플릿 선택 (발신프로필 선택 시 자동 로딩)
6. 수신번호 입력 (여러 번호는 엔터로 구분)
7. 변수 값 입력 (템플릿에 변수가 있는 경우):
   - 예: `고객명`: `홍길동`
   - 예: `배송상태`: `배송중`
   - 예: `송장번호`: `1234567890`
8. 회신번호 선택 (필수)
9. "발송" 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 엔드포인트 | `POST /api/messages/kakao/alimtalk/send` |
| MTS 응답 코드 | `0000` 또는 `1000` (알림톡 성공) |
| 변수 치환 | 정확히 치환됨 |
| 카카오톡 수신 | 알림톡 형태로 수신 |
| 잔액 차감 | -15원 |
| DB 저장 | `message_logs` 테이블 삽입 (type='ALIMTALK') |

**성공 기준:**
- ✅ MTS 응답 코드 `0000` 또는 `1000`
- ✅ 카카오톡에서 알림톡 수신 (노란색 배경)
- ✅ 변수가 정확히 치환되어 표시됨
- ✅ 잔액 15원 차감

**실패 시 조치:**
- 에러 코드 `3015`: 템플릿 없음 → 템플릿 코드 확인
- 에러 코드 `3016`: 템플릿 불일치 → 변수 이름 확인
- 에러 코드 `1003`: 발신프로필 키 오류 → sender_key 확인

**⚠️ 중요 발견사항 (2025-10-30):**
- MTS API 문서에는 알림톡 성공 코드가 `1000`으로 명시되어 있으나, 실제로는 `0000` 반환
- `src/lib/mtsApi.ts`의 `sendMtsAlimtalk()` 함수에서 두 코드 모두 처리하도록 수정됨
- 코드: `if (result.code === '0000' || result.code === '1000')`

**🚨 알려진 이슈 (2025-10-30):**
- **증상**: MTS API 호출 성공 (`code: '0000'`) 하지만 실제 카카오톡 수신 안됨
- **테스트 결과**:
  - ✅ API 호출: 성공
  - ✅ MTS 응답 코드: `0000` (성공)
  - ❌ 카카오톡 수신: 실패 (메시지 안옴)
  - ❌ message_logs 저장: 실패 (로그 미생성)
  - ❌ 잔액 차감: 실패 (광고머니 차감 안됨)
- **추정 원인**:
  1. MTS 측 알림톡 발송 환경 설정 미완료 가능성
  2. 발신프로필 또는 템플릿의 실제 승인 상태 불일치 가능성
  3. MTS API 테스트 계정 설정 문제
- **다음 조치**: MTS 측에 문의하여 환경 설정 확인 필요

**📝 추후 구현 예정**:
- 알림톡 예약 발송 기능 (현재 즉시 발송만 지원)
- 예약 로직 구현 후 "전송/예약 준비" 버튼으로 통합 예정

---

### 테스트 시나리오 3.2: 알림톡 버튼 테스트

**목적**: 알림톡 버튼 클릭 동작 확인

**사전 준비:**
- 버튼이 포함된 템플릿 (예: "자세히 보기" 버튼)

**테스트 단계:**

1. 버튼이 있는 알림톡 템플릿 선택
2. 버튼 URL 설정:
   - 버튼명: `자세히 보기`
   - type: `WL` (웹링크)
   - url_mobile: `https://example.com/order/12345`
3. 발송 후 수신 확인
4. 카카오톡에서 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 버튼 표시 | 카카오톡에 버튼 표시됨 |
| 버튼 클릭 | 설정한 URL로 이동 |
| URL 파라미터 | 정확히 전달됨 |

**성공 기준:**
- ✅ 버튼이 카카오톡 메시지에 표시됨
- ✅ 버튼 클릭 시 올바른 URL로 이동
- ✅ 모바일 브라우저에서 페이지 정상 표시

---

### 테스트 시나리오 3.3: 알림톡 → SMS 전환 발송

**목적**: 알림톡 실패 시 SMS로 자동 전환 확인

**테스트 단계:**

1. 알림톡 발송 설정
2. "SMS 백업 발송" 옵션 활성화
3. 전환 메시지 입력:
   ```
   [알림] 주문하신 상품이 배송중입니다. (SMS 백업)
   ```
4. 수신번호: 카카오톡이 설치되지 않은 번호 (또는 테스트용 실패 번호)
5. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 1차 시도 | 알림톡 발송 시도 |
| MTS 응답 | 에러 코드 `3019` (톡 유저 아님) |
| 2차 시도 | SMS로 자동 전환 발송 |
| SMS 발송 성공 | 응답 코드 `0000` |
| 잔액 차감 | -35원 (알림톡 15원 + SMS 20원) |

**성공 기준:**
- ✅ 알림톡 실패 시 자동으로 SMS 발송
- ✅ SMS 메시지 내용이 설정한 전환 메시지와 일치
- ✅ 총 잔액 차감 = 알림톡 시도 비용 + SMS 성공 비용

**⚠️ 참고**:
- SMS 전환 발송은 **발신번호가 MTS에 등록되어 있어야** 작동합니다.
- 발신번호 미등록 시 알림톡은 실패하고 SMS 전환도 ER17 오류로 실패합니다.

---

## Phase 4: 카카오 친구톡 V2 테스트

### 📌 사전 조건

- ✅ **카카오 발신프로필이 DB에 등록되어 있음** (`kakao_sender_profiles` 테이블)
- ✅ 카카오톡 채널 개설 완료
- ✅ 친구톡 V2 API 엔드포인트 확인 (`/v2/sndng/ftk/sendMessage`)

### 📋 Phase 4 테스트 체크리스트

#### ✅ 4.1 텍스트형 친구톡 (FT)
- [ ] "친구톡" 서브 탭 선택 가능
- [ ] 발신프로필 선택 가능
- [ ] 메시지 타입 "FT (텍스트형)" 선택 가능
- [ ] 광고 여부 선택 UI 표시 (ad_flag)
- [ ] 광고 여부 "아니오" (N) 선택
- [ ] 메시지 내용 입력
- [ ] "발송" 버튼 클릭 성공
- [ ] MTS 응답 코드 1000 확인
- [ ] API 엔드포인트 /v2/sndng/ftk/sendMessage 호출 확인
- [ ] messageType=FT 확인
- [ ] 카카오톡 친구톡 수신 확인 (흰색 배경)
- [ ] 알림톡과 구분되는 UI 확인
- [ ] 잔액 30원 차감 확인
- [ ] message_logs에 type='FRIENDTALK' 저장 확인

#### ✅ 4.2 이미지형 친구톡 (FI)
- [ ] 메시지 타입 "FI (이미지형)" 선택
- [ ] 이미지 업로드 UI 표시
- [ ] 이미지 파일 업로드 또는 URL 입력
- [ ] 이미지 미리보기 표시
- [ ] 메시지 내용 입력
- [ ] 발송 성공 확인
- [ ] messageType=FI 확인
- [ ] 카카오톡 수신 메시지에 이미지 표시 확인
- [ ] 텍스트 내용도 함께 표시 확인
- [ ] 잔액 30원 차감 확인
- [ ] metadata에 image_urls 저장 확인

#### ✅ 4.3 광고형 친구톡 (ad_flag=Y)
- [ ] 광고 여부 "예" (Y) 선택
- [ ] 현재 시각 확인 (08:00-20:00 여부)
- [ ] **케이스 A** (08:00-20:00): 발송 성공
- [ ] **케이스 A**: MTS 응답 코드 1000 확인
- [ ] **케이스 A**: 카카오톡에 "(광고)" 표시 확인
- [ ] **케이스 A**: 잔액 30원 차감 확인
- [ ] **케이스 B** (20:01-07:59): 발송 차단
- [ ] **케이스 B**: 클라이언트 에러 또는 MTS 에러 3022 확인
- [ ] **케이스 B**: 에러 메시지 "광고성 메시지는 08:00-20:00에만 발송 가능" 표시
- [ ] **케이스 B**: 잔액 차감 없음 확인

---

### 테스트 시나리오 4.1: 텍스트형 친구톡 (FT)

**목적**: 텍스트만 포함된 친구톡 발송 확인

**테스트 단계:**

1. "카카오/네이버 톡톡" 탭 → "친구톡" 서브 탭
2. 발신프로필 선택
3. 메시지 타입: **FT (텍스트형)** 선택
4. 광고 여부: `아니오` (ad_flag=N)
5. 메시지 내용:
   ```
   안녕하세요! 친구톡 테스트 메시지입니다.
   ```
6. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `1000` |
| messageType | FT |
| 카카오톡 수신 | 친구톡 형태 (흰색 배경) |
| 잔액 차감 | -30원 |

**성공 기준:**
- ✅ 친구톡 형태로 수신 (알림톡과 구분됨)
- ✅ 잔액 30원 차감

---

### 테스트 시나리오 4.2: 이미지형 친구톡 (FI)

**목적**: 이미지가 포함된 친구톡 발송 확인

**사전 준비:**
- 이미지 URL (MTS API로 업로드한 이미지 경로)

**테스트 단계:**

1. 메시지 타입: **FI (이미지형)** 선택
2. 이미지 URL 입력: `/2025/01/29/test-image.jpg`
3. 메시지 내용:
   ```
   이미지가 포함된 친구톡입니다.
   ```
4. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| messageType | FI |
| 이미지 표시 | 카카오톡에 이미지 표시됨 |
| 잔액 차감 | -30원 |

**성공 기준:**
- ✅ 이미지가 정상적으로 표시됨
- ✅ 메시지 내용도 함께 표시됨

---

### 테스트 시나리오 4.3: 광고형 친구톡 (ad_flag=Y)

**목적**: 광고성 친구톡 발송 시간 제한 확인

**테스트 단계:**

1. 광고 여부: `예` (ad_flag=Y) 선택
2. 현재 시각 확인:
   - **케이스 A**: 08:00 ~ 20:00 사이 → 발송 가능
   - **케이스 B**: 20:01 ~ 07:59 사이 → 발송 불가

**케이스 A (허용 시간대) 예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 발송 허용 | 예 |
| MTS 응답 코드 | `1000` |
| 카카오톡 수신 | (광고) 표시와 함께 수신 |

**케이스 B (제한 시간대) 예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 발송 차단 | 클라이언트에서 차단 |
| 에러 메시지 | "광고성 메시지는 08:00-20:00에만 발송 가능합니다" |
| 또는 MTS 에러 | 코드 `3022` (발송 시간 아님) |

**성공 기준:**
- ✅ 허용 시간대에는 정상 발송
- ✅ 제한 시간대에는 발송 차단 또는 에러 반환
- ✅ (광고) 표시가 메시지에 포함됨

---

## Phase 5: 네이버 톡톡 테스트

### 📌 사전 조건

- ✅ 네이버톡 ID (navertalk_id) 발급 완료
- ✅ 네이버 톡톡 템플릿 최소 1개 등록 완료
- ✅ 템플릿 코드 확인

### 📋 Phase 5 테스트 체크리스트

#### ✅ 5.1 네이버 톡톡 발송
- [ ] "네이버 톡톡" 서브 탭 선택 가능
- [ ] 네이버톡 ID 입력 필드 표시
- [ ] 네이버톡 ID 입력
- [ ] 템플릿 선택 UI 표시 (자동 로딩)
- [ ] 템플릿 선택 가능
- [ ] 상품 코드 선택 가능 (INFORMATION/BENEFIT/CARDINFO)
- [ ] 상품 코드 선택 (예: INFORMATION)
- [ ] 템플릿 변수 입력 필드 표시 (있을 경우)
- [ ] 변수 값 입력 (필요 시)
- [ ] 수신번호 입력
- [ ] "발송" 버튼 클릭 성공
- [ ] MTS 응답 코드 1000 확인
- [ ] 네이버 톡톡 앱에서 수신 확인
- [ ] 스마트알림 형태로 표시 확인
- [ ] 템플릿 내용 정확히 치환 확인
- [ ] 잔액 15원 차감 확인
- [ ] message_logs에 type='NAVERTALK' 저장 확인
- [ ] metadata에 navertalk_id, template_code, product_code 저장 확인

#### ✅ 5.2 네이버 톡톡 버튼 테스트
- [ ] 버튼 포함 템플릿 선택
- [ ] 버튼 설정 UI 표시
- [ ] 버튼 타입 선택 (WEB_LINK)
- [ ] 버튼명 입력 (예: "배송조회")
- [ ] 버튼 URL 입력
- [ ] 발송 성공 확인
- [ ] 네이버 톡톡 수신 메시지에 버튼 표시 확인
- [ ] 버튼 클릭 시 설정한 URL로 이동 확인
- [ ] metadata에 buttons 정보 저장 확인

---

### 테스트 시나리오 5.1: 네이버 톡톡 발송

**목적**: 네이버 톡톡 스마트알림 발송 확인

**테스트 단계:**

1. "카카오/네이버 톡톡" 탭 → "네이버 톡톡" 서브 탭
2. 네이버톡 ID 입력
3. 템플릿 선택 (자동 로딩)
4. 상품 코드 선택:
   - `INFORMATION` (정보성-알림)
   - `BENEFIT` (마케팅-혜택)
   - `CARDINFO` (카드 알림)
5. 템플릿 변수 치환 (필요 시)
6. 수신번호 입력
7. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `1000` |
| 네이버 톡톡 수신 | 스마트알림 형태로 수신 |
| 잔액 차감 | -15원 |
| DB 저장 | type='NAVERTALK' |

**성공 기준:**
- ✅ 네이버 톡톡 앱에서 수신 확인
- ✅ 템플릿 내용이 정확히 치환됨
- ✅ 잔액 15원 차감

---

### 테스트 시나리오 5.2: 네이버 톡톡 버튼 테스트

**목적**: 네이버 톡톡 버튼 클릭 동작 확인

**테스트 단계:**

1. 버튼이 포함된 템플릿 선택
2. 버튼 설정:
   ```json
   {
     "type": "WEB_LINK",
     "name": "배송조회",
     "url": "https://tracking.example.com/12345"
   }
   ```
3. 발송 후 수신 확인
4. 네이버 톡톡에서 버튼 클릭

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| 버튼 표시 | 네이버 톡톡에 버튼 표시됨 |
| 버튼 클릭 | 설정한 URL로 이동 |

**성공 기준:**
- ✅ 버튼이 네이버 톡톡 메시지에 표시됨
- ✅ 버튼 클릭 시 올바른 URL로 이동

---

## Phase 6: 카카오 브랜드 메시지 테스트

### 📌 사전 조건

- ✅ 카카오 브랜드 메시지 권한 획득
- ✅ 브랜드 메시지 템플릿 등록 및 승인 완료
- ✅ send_mode 파라미터 수정 완료 (`'2'` 사용)

### 📋 Phase 6 테스트 체크리스트

#### ✅ 6.1 텍스트형 브랜드 메시지 (TEXT)
- [ ] "브랜드 메시지" 서브 탭 선택 가능
- [ ] 발신프로필 선택 가능
- [ ] 템플릿 코드 입력 필드 표시
- [ ] 템플릿 코드 입력
- [ ] 메시지 타입 "TEXT" 선택
- [ ] 메시지 내용 입력
- [ ] "발송" 버튼 클릭 성공
- [ ] API 파라미터 send_mode='2' 확인 (즉시발송)
- [ ] MTS 응답 코드 1000 확인
- [ ] 카카오톡 브랜드 메시지 수신 확인
- [ ] 잔액 15원 차감 확인
- [ ] message_logs에 type='BRAND' 저장 확인
- [ ] metadata에 sender_key, template_code, messageType='TEXT' 저장 확인

#### ✅ 6.2 이미지형 브랜드 메시지 (IMAGE)
- [ ] 메시지 타입 "IMAGE" 선택
- [ ] 이미지 첨부 UI 표시 (attachment 설정)
- [ ] 이미지 파일 업로드 또는 URL 입력
- [ ] 이미지 미리보기 표시
- [ ] 메시지 내용 입력
- [ ] 발송 성공 확인
- [ ] 카카오톡 수신 메시지에 이미지 표시 확인
- [ ] 브랜드 메시지 형태 확인
- [ ] 잔액 15원 차감 확인
- [ ] metadata에 attachment 정보 저장 확인

---

### 테스트 시나리오 6.1: 텍스트형 브랜드 메시지 (TEXT)

**목적**: 텍스트 브랜드 메시지 발송 확인

**테스트 단계:**

1. "카카오/네이버 톡톡" 탭 → "브랜드 메시지" 서브 탭
2. 발신프로필 선택
3. 템플릿 코드 입력
4. 메시지 타입: **TEXT** 선택
5. 메시지 내용 입력
6. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 파라미터 | send_mode='2' |
| MTS 응답 코드 | `1000` |
| 카카오톡 수신 | 브랜드 메시지 형태 |
| 잔액 차감 | -15원 |

**성공 기준:**
- ✅ 브랜드 메시지로 수신
- ✅ send_mode가 '2'로 전송됨 (API 로그 확인)
- ✅ 잔액 15원 차감

---

### 테스트 시나리오 6.2: 이미지형 브랜드 메시지 (IMAGE)

**목적**: 이미지가 포함된 브랜드 메시지 발송 확인

**테스트 단계:**

1. 메시지 타입: **IMAGE** 선택
2. 이미지 URL 입력
3. 메시지 내용 입력
4. 발송

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| messageType | IMAGE |
| 이미지 표시 | 카카오톡에 이미지 표시됨 |
| 잔액 차감 | -15원 |

**성공 기준:**
- ✅ 이미지가 정상적으로 표시됨
- ✅ 브랜드 메시지 형태로 수신

---

## Phase 7: 시스템 알림 테스트

### 📌 사전 조건

- ✅ `smsNotification.ts`가 MTS API로 전환됨
- ✅ 시스템 대표 발신번호가 등록됨

### 📋 Phase 7 테스트 체크리스트

#### ✅ 7.1 사업자 인증 신청 알림
- [ ] 일반 사용자 계정으로 로그인
- [ ] 사업자 인증 페이지 접속 (/my-site/advertiser/business-verification)
- [ ] 사업자 정보 입력 필드 정상 표시
- [ ] 사업자등록증 파일 업로드 가능
- [ ] "인증 신청" 버튼 클릭 성공
- [ ] API 호출 POST /api/business-verification/submit 확인
- [ ] triggerNotification() 함수 실행 확인
- [ ] 관리자 계정 조회 (role='admin')
- [ ] 관리자 휴대폰 번호 확인
- [ ] SMS 내용 "새로운 사업자 인증 신청이 있습니다" 확인
- [ ] MTS 응답 코드 0000 확인
- [ ] 1분 이내 관리자 휴대폰에 SMS 수신 확인
- [ ] 발신번호가 시스템 대표 번호인지 확인

#### ✅ 7.2 문의 답변 알림
- [ ] 사용자 A 계정으로 로그인
- [ ] 문의 등록 페이지 접속
- [ ] "SMS 알림 받기" 체크박스 선택
- [ ] 문의 내용 입력 및 등록
- [ ] 관리자 계정으로 로그인
- [ ] 문의 답변 페이지 접속
- [ ] 답변 내용 작성
- [ ] "답변 등록" 버튼 클릭
- [ ] API 호출 POST /api/inquiries/[id]/reply 확인
- [ ] inquiry.sms_notification === true 조건 확인
- [ ] SMS 발송 대상: 문의 작성자 확인
- [ ] SMS 내용 "문의하신 내용에 답변이 등록되었습니다" 확인
- [ ] MTS 응답 코드 0000 확인
- [ ] 사용자 A 휴대폰에 SMS 수신 확인
- [ ] SMS 내 링크 클릭 시 문의 상세 페이지 이동 확인

#### ✅ 7.3 회원 승인 알림
- [ ] 관리자 계정으로 로그인
- [ ] 회원 관리 페이지 접속
- [ ] 대기 중인 회원 목록 확인
- [ ] 승인 처리할 회원 선택
- [ ] "승인" 버튼 클릭
- [ ] API 호출 POST /api/admin/send-approval-notification 확인
- [ ] SMS 발송 대상: 승인된 사용자 확인
- [ ] SMS 내용 "회원 가입이 승인되었습니다" 확인
- [ ] MTS 응답 코드 0000 확인
- [ ] 승인된 사용자 휴대폰에 SMS 수신 확인

---

### 테스트 시나리오 7.1: 사업자 인증 신청 알림

**목적**: 사업자 인증 신청 시 관리자에게 SMS 발송 확인

**테스트 단계:**

1. 일반 사용자 계정으로 로그인
2. 사업자 인증 페이지 접속 (`/my-site/advertiser/business-verification`)
3. 사업자 정보 입력
4. 사업자등록증 파일 업로드
5. "인증 신청" 버튼 클릭
6. 관리자 휴대폰 확인 (1분 이내)

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 호출 | `POST /api/business-verification/submit` |
| 내부 함수 호출 | `triggerNotification()` 실행 |
| SMS 발송 대상 | 관리자 (role='admin') |
| SMS 내용 | "새로운 사업자 인증 신청이 있습니다" |
| 발송 성공 | MTS 응답 코드 `0000` |
| 관리자 수신 | 1분 이내 SMS 수신 |

**성공 기준:**
- ✅ 사업자 인증 신청 즉시 관리자에게 SMS 발송
- ✅ SMS 내용이 정확함
- ✅ 발신번호가 시스템 대표 번호임

---

### 테스트 시나리오 7.2: 문의 답변 알림

**목적**: 문의 답변 등록 시 사용자에게 SMS 발송 확인

**사전 조건:**
- 사용자가 문의 등록 시 "SMS 알림 받기" 체크

**테스트 단계:**

1. 사용자 A가 문의 등록 (SMS 알림 체크)
2. 관리자 계정으로 로그인
3. 문의 답변 페이지 접속
4. 답변 내용 작성
5. "답변 등록" 버튼 클릭
6. 사용자 A의 휴대폰 확인

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 호출 | `POST /api/inquiries/[id]/reply` |
| 조건 확인 | `inquiry.sms_notification === true` |
| SMS 발송 대상 | 문의 작성자 |
| SMS 내용 | "문의하신 내용에 답변이 등록되었습니다" |
| 발송 성공 | MTS 응답 코드 `0000` |

**성공 기준:**
- ✅ SMS 알림 체크한 사용자만 수신
- ✅ 답변 등록 즉시 SMS 발송
- ✅ 링크 클릭 시 문의 상세 페이지 이동

---

### 테스트 시나리오 7.3: 회원 승인 알림

**목적**: 회원 승인 시 사용자에게 SMS 발송 확인

**테스트 단계:**

1. 관리자가 대기 중인 회원 승인 처리
2. 승인된 사용자의 휴대폰 확인

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| API 호출 | `POST /api/admin/send-approval-notification` |
| SMS 발송 대상 | 승인된 사용자 |
| SMS 내용 | "회원 가입이 승인되었습니다" |

**성공 기준:**
- ✅ 승인 처리 즉시 SMS 발송
- ✅ 사용자가 정상적으로 수신

---

## Phase 8: Cron Job 예약 발송 테스트

### 📌 사전 조건

- ✅ Cron Job 설정 확인
- ✅ `scheduled_messages` 테이블 접근 권한

### 📋 Phase 8 테스트 체크리스트

#### ✅ 8.1 카카오 알림톡 예약 발송
- [ ] DB scheduled_messages 테이블에 예약 데이터 삽입
- [ ] message_type = 'ALIMTALK' 확인
- [ ] scheduled_at 시간 설정 (현재 + 3분)
- [ ] status = 'pending' 확인
- [ ] metadata에 sender_key, template_code 포함 확인
- [ ] Cron Job 대기 (3분)
- [ ] Cron Job 실행 로그 확인
- [ ] scheduled-send-check API 호출 확인
- [ ] MTS API /sndng/atk/sendMessage 호출 확인
- [ ] MTS 응답 코드 1000 확인
- [ ] status = 'sent' 변경 확인
- [ ] sent_at 시간 기록 확인
- [ ] 잔액 15원 차감 확인
- [ ] message_logs 테이블 기록 확인
- [ ] transactions 테이블 기록 확인
- [ ] 카카오톡 알림톡 수신 확인

#### ✅ 8.2 카카오 친구톡 예약 발송
- [ ] DB에 친구톡 예약 데이터 삽입
- [ ] message_type = 'FRIENDTALK' 확인
- [ ] metadata에 sender_key, messageType='FT' 포함 확인
- [ ] scheduled_at 시간 설정 (현재 + 3분)
- [ ] Cron Job 실행 대기
- [ ] MTS API /v2/sndng/ftk/sendMessage 호출 확인
- [ ] MTS 응답 코드 1000 확인
- [ ] status = 'sent' 변경 확인
- [ ] 잔액 30원 차감 확인
- [ ] 카카오톡 친구톡 수신 확인

#### ✅ 8.3 네이버 톡톡 예약 발송
- [ ] DB에 네이버 톡톡 예약 데이터 삽입
- [ ] message_type = 'NAVERTALK' 확인
- [ ] metadata에 navertalk_id, template_code 포함 확인
- [ ] scheduled_at 시간 설정 (현재 + 3분)
- [ ] Cron Job 실행 대기
- [ ] MTS API 호출 확인
- [ ] MTS 응답 코드 1000 확인
- [ ] status = 'sent' 변경 확인
- [ ] 잔액 15원 차감 확인
- [ ] 네이버 톡톡 수신 확인

---

### 테스트 시나리오 8.1: 카카오 알림톡 예약 발송

**목적**: scheduled-send-check Cron Job의 알림톡 발송 확인

**테스트 단계:**

1. DB에 직접 예약 메시지 삽입:
```sql
INSERT INTO scheduled_messages (
  user_id,
  to_number,
  message_content,
  message_type,
  scheduled_at,
  status,
  metadata
) VALUES (
  'test-user-id',
  '01012345678',
  '예약 알림톡 테스트',
  'ALIMTALK',
  NOW() + INTERVAL '2 minutes',
  'pending',
  '{"sender_key": "xxx", "template_code": "xxx"}'::jsonb
);
```

2. 2분 대기
3. Cron Job 로그 모니터링
4. 카카오톡 수신 확인
5. DB status 확인

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| Cron Job 실행 | 1분마다 체크 |
| 조건 만족 | `scheduled_at <= NOW()` AND `status='pending'` |
| MTS API 호출 | `POST /sndng/atk/sendMessage` |
| metadata 추출 | sender_key, template_code 정확히 추출 |
| 발송 성공 | MTS 응답 `1000` |
| status 업데이트 | `pending` → `sent` |
| sent_at 기록 | 현재 시각 |
| mts_msg_id 저장 | msg_id 저장됨 |

**성공 기준:**
- ✅ 예약 시간 도달 시 ±1분 이내 발송
- ✅ 메시지 타입별 올바른 API 호출
- ✅ metadata에서 파라미터 정확히 추출
- ✅ DB status 업데이트

---

### 테스트 시나리오 8.2: 네이버 톡톡 예약 발송

**목적**: scheduled-send-check Cron Job의 네이버 톡톡 발송 확인

**테스트 단계:**

1. DB에 예약 메시지 삽입:
```sql
INSERT INTO scheduled_messages (
  user_id,
  to_number,
  message_content,
  message_type,
  scheduled_at,
  status,
  metadata
) VALUES (
  'test-user-id',
  '01012345678',
  '예약 네이버톡 테스트',
  'NAVERTALK',
  NOW() + INTERVAL '3 minutes',
  'pending',
  '{"navertalk_id": "xxx", "template_code": "xxx", "product_code": "INFORMATION"}'::jsonb
);
```

2. 3분 대기
3. 네이버 톡톡 수신 확인

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS API 호출 | `POST /sndng/nti/sendMessage` |
| 파라미터 매핑 | navertalk_id, code, productCode 정확 |
| 발송 성공 | MTS 응답 `1000` |

**성공 기준:**
- ✅ 네이버 톡톡으로 정상 수신
- ✅ 메타데이터 필드 정확히 추출 (snake_case/camelCase 모두 지원)

---

### 테스트 시나리오 8.3: 카카오 브랜드 메시지 예약 발송

**목적**: Cron Job의 브랜드 메시지 발송 확인

**테스트 단계:**

1. DB에 예약 메시지 삽입:
```sql
INSERT INTO scheduled_messages (
  user_id,
  to_number,
  message_content,
  message_type,
  scheduled_at,
  status,
  metadata
) VALUES (
  'test-user-id',
  '01012345678',
  '예약 브랜드 메시지',
  'BRAND',
  NOW() + INTERVAL '2 minutes',
  'pending',
  '{"sender_key": "xxx", "template_code": "xxx", "message_type": "TEXT"}'::jsonb
);
```

2. 2분 대기
3. 카카오톡 수신 확인

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS API 호출 | `POST /btalk/send/message/basic` |
| send_mode | '2' (즉시발송) |
| 발송 성공 | MTS 응답 `1000` |

**성공 기준:**
- ✅ 브랜드 메시지로 정상 수신
- ✅ send_mode가 '2'로 전송됨

---

## 에러 핸들링 테스트

### 테스트 시나리오 E.1: 발신번호 오류 (에러 3008)

**목적**: 잘못된 발신번호 사용 시 에러 처리 확인

**테스트 단계:**

1. 발신번호: `010-0000-0000` (존재하지 않는 번호)
2. SMS 발송 시도

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `3008` |
| 에러 메시지 | "전화번호 오류" |
| UI 표시 | 사용자에게 에러 메시지 표시 |
| DB 저장 | error_code='3008' 기록 |

---

### 테스트 시나리오 E.2: 템플릿 없음 (에러 3015)

**목적**: 존재하지 않는 템플릿 코드 사용 시 에러 처리

**테스트 단계:**

1. 알림톡 발송
2. 템플릿 코드: `invalid_template_code`
3. 발송 시도

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `3015` |
| 에러 메시지 | "템플릿을 찾을 수 없음" |
| UI 표시 | "템플릿 코드를 확인해주세요" |

---

### 테스트 시나리오 E.3: 템플릿 불일치 (에러 3016)

**목적**: 템플릿 내용과 실제 메시지 불일치 시 에러 처리

**테스트 단계:**

1. 템플릿: `안녕하세요 #{고객명}님`
2. 발송 메시지: `안녕하세요 홍길동님 (변수 #{} 없음)`
3. 발송 시도

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `3016` |
| 에러 메시지 | "메시지 내용이 템플릿과 일치하지 않음" |

---

### 테스트 시나리오 E.4: 발송 시간 제한 (에러 3022)

**목적**: 광고성 메시지 시간 제한 확인

**테스트 단계:**

1. 친구톡 광고형 (ad_flag=Y)
2. 현재 시각: 21:00 (제한 시간대)
3. 발송 시도

**예상 결과:**

| 항목 | 예상 값 |
|------|--------|
| MTS 응답 코드 | `3022` |
| 에러 메시지 | "메시지 발송 가능한 시간이 아님" |
| UI 표시 | "광고성 메시지는 08:00-20:00에만 발송 가능합니다" |

---

## 성능 테스트

### 테스트 시나리오 P.1: 대량 발송 (100명)

**목적**: 다중 수신자 발송 성능 확인

**테스트 단계:**

1. 수신자 100명 준비 (엑셀 또는 주소록)
2. SMS 발송
3. 발송 시간 측정
4. 성공/실패 건수 집계

**예상 결과:**

| 항목 | 목표 값 |
|------|--------|
| 발송 완료 시간 | 100건 기준 5분 이내 |
| 성공률 | 95% 이상 |
| API 응답 시간 | 평균 500ms 이하 |
| DB 트랜잭션 | 모두 commit 완료 |

---

### 테스트 시나리오 P.2: 동시 발송 (3명)

**목적**: 여러 사용자가 동시에 발송할 때 안정성 확인

**테스트 단계:**

1. 3개의 브라우저/계정 준비
2. 동시에 메시지 발송 (같은 시각)
3. 각 발송 결과 확인

**예상 결과:**

| 항목 | 목표 값 |
|------|--------|
| 모든 발송 성공 | 3건 모두 성공 |
| DB 락 발생 | 없음 |
| 잔액 차감 오류 | 없음 |

---

## 최종 체크리스트

### ✅ 기본 기능 (필수)

| 항목 | 상태 | 비고 |
|------|------|------|
| SMS 즉시 발송 | ⬜ |  |
| LMS 즉시 발송 | ⬜ |  |
| MMS 즉시 발송 | ⬜ |  |
| SMS 예약 발송 | ⬜ |  |
| 예약 발송 취소 | ⬜ |  |
| 다중 수신자 발송 | ⬜ |  |

### ✅ 카카오톡 (필수)

| 항목 | 상태 | 비고 |
|------|------|------|
| 알림톡 발송 | ⬜ |  |
| 알림톡 변수 치환 | ⬜ |  |
| 알림톡 버튼 | ⬜ |  |
| 알림톡 → SMS 전환 | ⬜ |  |
| 친구톡 FT (텍스트) | ⬜ |  |
| 친구톡 FI (이미지) | ⬜ |  |
| 친구톡 광고형 시간 제한 | ⬜ |  |
| 브랜드 메시지 TEXT | ⬜ |  |
| 브랜드 메시지 IMAGE | ⬜ |  |

### ✅ 네이버 (중요)

| 항목 | 상태 | 비고 |
|------|------|------|
| 네이버 톡톡 발송 | ⬜ |  |
| 네이버 톡톡 버튼 | ⬜ |  |

### ✅ 시스템 알림 (중요)

| 항목 | 상태 | 비고 |
|------|------|------|
| 사업자 인증 알림 | ⬜ |  |
| 문의 답변 알림 | ⬜ |  |
| 회원 승인 알림 | ⬜ |  |

### ✅ Cron Job (필수)

| 항목 | 상태 | 비고 |
|------|------|------|
| SMS 예약 발송 Cron | ⬜ |  |
| 알림톡 예약 발송 Cron | ⬜ |  |
| 친구톡 예약 발송 Cron | ⬜ |  |
| 네이버톡 예약 발송 Cron | ⬜ |  |
| 브랜드 메시지 예약 발송 Cron | ⬜ |  |

### ✅ 에러 핸들링 (중요)

| 항목 | 상태 | 비고 |
|------|------|------|
| 에러 3008 (전화번호 오류) | ⬜ |  |
| 에러 3015 (템플릿 없음) | ⬜ |  |
| 에러 3016 (템플릿 불일치) | ⬜ |  |
| 에러 3022 (시간 제한) | ⬜ |  |

### ✅ 성능 (선택)

| 항목 | 상태 | 비고 |
|------|------|------|
| 대량 발송 (100명) | ⬜ |  |
| 동시 발송 (3명) | ⬜ |  |

---

## 테스트 결과 기록 양식

```
====================================
MTS API 통합 테스트 결과
====================================
테스트 일시: YYYY-MM-DD HH:MM
테스터: [이름]
환경: [개발/스테이징/운영]

[Phase 1: SMS/LMS/MMS 즉시 발송]
✅ 1.1 SMS 단건 발송 - 성공 (msg_id: xxx)
✅ 1.2 LMS 장문 발송 - 성공
❌ 1.3 MMS 이미지 발송 - 실패 (에러: xxx)
   → 조치: 이미지 업로드 API 확인 필요

[Phase 2: 예약 발송]
✅ 2.1 SMS 예약 (5분 후) - 성공 (정확히 5분 후 수신)
✅ 2.2 예약 취소 - 성공

... (이하 생략)

[종합 평가]
총 테스트 항목: 45개
성공: 42개
실패: 3개
성공률: 93.3%

[주요 이슈]
1. MMS 이미지 업로드 실패 - 파일 크기 제한 확인 필요
2. 알림톡 에러 3016 발생 - 템플릿 재검수 필요
3. ...

[다음 조치사항]
1. MMS 이미지 업로드 API 디버깅
2. 알림톡 템플릿 재등록 및 승인 대기
3. ...
```

---

## 참고 문서

- [MTS API 전환 통합 가이드](./MTS_API_전환_통합_가이드.md)
- [MTS 연동규격서](./docs/연동규격서md/)
- [MTS Message 코드베이스 분석](./MTS_MESSAGE_코드베이스_분석_v4.0.md)

---

**문서 버전**: v1.1
**최종 수정**: 2025-10-30
**작성자**: MTS Message Team
**변경 이력**:
- v1.1 (2025-10-30): Phase 3-6 필드명 수정 (message_type → type), 카카오 채널 연동 플로우 추가, DB 기반 프로필 조회 명시
- v1.0 (2025-10-29): 초안 작성

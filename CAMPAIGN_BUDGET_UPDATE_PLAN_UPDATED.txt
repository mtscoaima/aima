# 캠페인 광고금액 로직 수정 계획서 (2024-09-29 현재 상태 반영)

## 📋 전체 개요

기존 "일 최대 건수" 기반 캠페인 예산 시스템을 "캠페인 전체 예산" + "일 최대 광고비 제한" 시스템으로 변경하는 프로젝트입니다.

## 🎯 주요 변경사항

### 변경 전
- 일 최대 건수 × 건당 단가 = 총 비용
- 승인 신청 시 잔액 차감
- 하드코딩된 5만원 최소값

### 변경 후
- 캠페인 전체 예산 (총 사용할 금액)
- 일 최대 광고비 제한 (하루 최대 소비 한도)
- 승인 완료 시 전체 예산 차감
- 관리자 설정 가능한 최소 단가 (기본 20만원)

## 📊 현재 구현 진행 상황

### ✅ 완료된 항목

#### 1. 데이터베이스 스키마 (✅ 기본 완료)
- **campaigns.budget**: 기존 필드 활용 중
- **system_settings.site_settings**: minimum_campaign_price: "200000", default_daily_limit: "50000" 저장됨

#### 2. 타입 정의 업데이트 (✅ 완료)
- **src/types/targetMarketing.ts**:
  - `budget`, `campaign_budget`, `daily_ad_spend_limit` 필드 추가
  - 기존 `max_recipients` 필드는 유지되지만 주석 처리

- **src/app/api/campaigns/route.ts**:
  - CreateCampaignRequest 인터페이스에 새로운 예산 필드들 추가
  - 기존 maxRecipients는 주석 처리

#### 3. 프론트엔드 UI 변경 (✅ 완료)
- **src/components/target-marketing/TargetMarketingDetail.tsx**:
  - `campaignBudget`, `dailyAdSpendLimit` 상태 추가
  - UI에 "캠페인 예산", "일 최대 광고비 제한" 필드 표시
  - 기존 `maxRecipients` 상태는 유지되지만 사용 안 함

#### 4. 계산 로직 업데이트 (✅ 완료)
- **src/hooks/useTargetMarketing.ts**:
  - `calculateTotalCost` 함수를 새로운 로직으로 변경
  - 캠페인 전체 예산(campaignBudget) 기준으로 계산
  - 기존 로직은 `calculateTotalCostLegacy`로 백업 유지

#### 5. 백엔드 API 업데이트 (✅ 완료)
- **src/app/api/campaigns/route.ts**:
  - `budget`, `campaign_budget`, `daily_ad_spend_limit` 필드를 DB에 저장
  - 승인 시 캠페인 전체 예산 차감 로직 구현

#### 6. 기존 시스템 활용 (✅ 완료)
- **관리자 설정 API**: 기존 `/api/admin/system-settings` 활용
- **관리자 설정 페이지**: 기존 `/admin/system-settings` 활용

### ⚠️ 부분 완료된 항목

#### 7. 데이터베이스 스키마 완성 (⚠️ 확인 필요)
**상태**: 코드는 구현되었으나 실제 DB 컬럼 존재 여부 확인 필요
- `campaigns.daily_ad_spend_limit` 컬럼 추가 필요할 수 있음
- `campaigns.campaign_budget` 컬럼 추가 필요할 수 있음

#### 8. 최소 단가 검증 로직 (⚠️ 부분 완료)
**현재 상태**: 하드코딩된 20만원 사용 중
**필요한 작업**: 관리자 설정에서 동적으로 가져오는 로직 구현

#### 9. 잔액 차감 로직 (⚠️ 부분 완료)
**현재 상태**: API에서는 새로운 로직 구현됨
**필요한 작업**: 프론트엔드 BalanceContext 업데이트

### ❌ 미완료된 항목

#### 10. 기존 코드 정리 (❌ 미완료)
- UI에서 maxRecipients 관련 필드 완전 제거
- 관련 상태 및 로직 정리
- 주석 처리된 코드들 완전 삭제

#### 11. 승인 프로세스 업데이트 (❌ 확인 필요)
- 승인 API에서 새로운 예산 로직 적용 여부 확인
- 마이너스 잔액 처리 로직 구현

## 🔧 남은 작업 목록

### 높은 우선순위
1. **DB 스키마 확인 및 보완**
   ```sql
   -- 필요시 실행
   ALTER TABLE campaigns ADD COLUMN daily_ad_spend_limit DECIMAL(12,2) DEFAULT 50000.00;
   ALTER TABLE campaigns ADD COLUMN campaign_budget DECIMAL(12,2);
   ```

2. **최소 단가 동적 로딩 구현**
   - 관리자 설정에서 minimum_campaign_price 값 가져오기
   - 프론트엔드 실시간 검증 로직 업데이트

3. **기존 maxRecipients 코드 완전 제거**
   - UI 컴포넌트에서 관련 필드 삭제
   - 상태 관리 코드 정리
   - 주석 처리된 코드 삭제

### 중간 우선순위
4. **승인 프로세스 검증**
   - `/api/admin/campaigns/[id]/approve/route.ts` 새로운 로직 적용 확인
   - 잔액 부족 시 처리 로직 확인

5. **BalanceContext 업데이트**
   - 새로운 예산 계산 로직 적용
   - 마이너스 잔액 표시 로직 구현

### 낮은 우선순위
6. **관리자 설정 UI 개선**
   - 캠페인 예산 관련 설정 표시 개선
   - 설정 변경 시 실시간 반영

7. **테스트 및 검증**
   - 전체 플로우 테스트
   - 에지 케이스 처리 확인

## 📁 관련 파일 목록

### 주요 완료된 파일
- ✅ `src/types/targetMarketing.ts`
- ✅ `src/components/target-marketing/TargetMarketingDetail.tsx`
- ✅ `src/hooks/useTargetMarketing.ts`
- ✅ `src/app/api/campaigns/route.ts`

### 확인/수정 필요한 파일
- ⚠️ `src/contexts/BalanceContext.tsx`
- ⚠️ `src/app/api/admin/campaigns/[id]/approve/route.ts`
- ⚠️ `src/app/api/admin/campaigns/[id]/reject/route.ts`

### 활용 가능한 기존 파일
- ✅ `src/app/api/admin/system-settings/*`
- ✅ `src/app/admin/system-settings/page.tsx`

## 🎯 다음 단계 실행 계획

1. **즉시 실행**
   - DB 스키마 확인 및 누락된 컬럼 추가
   - 기존 maxRecipients 코드 정리

2. **단기 (1-2일)**
   - 최소 단가 동적 로딩 구현
   - 승인 프로세스 검증

3. **중기 (3-5일)**
   - BalanceContext 업데이트
   - 전체 플로우 테스트

## 💡 구현 시 주의사항

1. **하위 호환성**: 기존 캠페인 데이터에 영향을 주지 않도록 주의
2. **점진적 전환**: 기존 로직을 바로 삭제하지 말고 단계적으로 전환
3. **데이터 검증**: 새로운 필드 추가 시 기본값 설정 및 NULL 처리
4. **사용자 경험**: UI 변경 시 사용자 혼란 최소화

## 📈 예상 효과

### 개선점
- 더 직관적인 예산 관리
- 유연한 일일 광고비 제한
- 관리자 설정을 통한 정책 변경 용이성

### 리스크 완화
- 단계적 구현으로 서비스 중단 최소화
- 기존 데이터 보존으로 롤백 가능성 확보
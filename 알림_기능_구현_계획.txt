# 알림 기능 구현 계획

## 1. 개요
- 현재 더미데이터로 구현된 알림 기능을 실제 데이터베이스 기반으로 구현
- 특정 사용자 또는 특정 역할의 모든 사용자에게 알림 전송 가능
- 우선 사업자 정보 인증 페이지에서 인증하기 버튼 클릭 시 모든 관리자에게 알림 전송

## 2. 데이터베이스 설계

### 2.1 notifications 테이블 생성
```sql
CREATE TABLE notifications (
  id BIGSERIAL PRIMARY KEY,
  recipient_user_id BIGINT NULL,                    -- 특정 사용자에게 전송 시 (NULL이면 역할 기반 전송)
  recipient_role VARCHAR(20) NULL,                  -- 역할 기반 전송 시 ('ADMIN', 'SALESPERSON', 'USER')
  sender_user_id BIGINT NULL,                       -- 알림을 생성한 사용자 (시스템 알림은 NULL)
  title VARCHAR(255) NOT NULL,                      -- 알림 제목
  message TEXT NOT NULL,                            -- 알림 내용
  type VARCHAR(50) NOT NULL DEFAULT 'INFO',         -- 알림 타입 ('INFO', 'WARNING', 'SUCCESS', 'ERROR', 'BUSINESS_VERIFICATION')
  action_url VARCHAR(500) NULL,                     -- 클릭 시 이동할 URL
  is_read BOOLEAN DEFAULT FALSE,                    -- 읽음 여부
  read_at TIMESTAMP NULL,                           -- 읽은 시간
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 생성 시간
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 수정 시간
  
  -- 제약 조건: recipient_user_id와 recipient_role 중 하나는 반드시 있어야 함
  CONSTRAINT chk_recipient CHECK (
    (recipient_user_id IS NOT NULL AND recipient_role IS NULL) OR 
    (recipient_user_id IS NULL AND recipient_role IS NOT NULL)
  ),
  
  -- 외래키
  FOREIGN KEY (recipient_user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (sender_user_id) REFERENCES users(id) ON DELETE SET NULL
);

-- 인덱스 생성
CREATE INDEX idx_notifications_recipient_user_id ON notifications(recipient_user_id);
CREATE INDEX idx_notifications_recipient_role ON notifications(recipient_role);
CREATE INDEX idx_notifications_created_at ON notifications(created_at DESC);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
```

### 2.2 notification_reads 테이블 (역할 기반 알림용)
```sql
-- 역할 기반 알림의 읽음 상태를 개별 사용자별로 관리
CREATE TABLE notification_reads (
  id BIGSERIAL PRIMARY KEY,
  notification_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  read_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(notification_id, user_id),
  FOREIGN KEY (notification_id) REFERENCES notifications(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_notification_reads_user_id ON notification_reads(user_id);
CREATE INDEX idx_notification_reads_notification_id ON notification_reads(notification_id);
```

## 3. API 엔드포인트 설계

### 3.1 알림 조회 API
- **GET /api/notifications**
  - 현재 로그인한 사용자의 알림 목록 조회
  - 쿼리 파라미터: page, limit, unread_only
  - 응답: 알림 목록, 총 개수, 읽지 않은 알림 개수

### 3.2 알림 읽음 처리 API
- **PUT /api/notifications/:id/read**
  - 특정 알림을 읽음으로 처리
- **PUT /api/notifications/mark-all-read**
  - 모든 알림을 읽음으로 처리

### 3.3 알림 전송 API (내부 시스템용)
- **POST /api/notifications/send**
  - 새로운 알림 생성 및 전송
  - 요청 본문:
    ```json
    {
      "recipient_user_id": 123,  // 또는 null
      "recipient_role": "ADMIN", // 또는 null
      "title": "사업자 인증 신청",
      "message": "새로운 사업자 인증 신청이 있습니다.",
      "type": "BUSINESS_VERIFICATION",
      "action_url": "/admin/user-management?tab=verification"
    }
    ```

## 4. 프론트엔드 구현

### 4.1 알림 상태 관리
- React Context 또는 전역 상태로 알림 관리
- 폴링 방식으로 새로운 알림 확인 (30초 간격)

### 4.2 Navigation 컴포넌트 수정
- 더미 데이터 제거
- 실제 API 호출로 알림 데이터 가져오기
- 읽지 않은 알림 개수 실시간 업데이트

### 4.3 알림 드롭다운 기능 개선
- 알림 클릭 시 해당 페이지로 이동
- 읽음/읽지않음 상태 표시
- 무한 스크롤 또는 페이지네이션

## 5. 사업자 인증 연동

### 5.1 사업자 인증 API 수정
- `/api/business-verification/submit` 엔드포인트에 알림 전송 로직 추가
- 성공적으로 제출된 후 모든 ADMIN 역할 사용자에게 알림 전송

### 5.2 알림 내용
```javascript
{
  recipient_role: "ADMIN",
  title: "새로운 사업자 인증 신청",
  message: `${사용자명}님이 사업자 인증을 신청했습니다. 검토가 필요합니다.`,
  type: "BUSINESS_VERIFICATION",
  action_url: "/admin/user-management?tab=verification&user_id=${user_id}"
}
```

## 6. 확장성 고려사항

### 6.1 알림 타입 확장
- BUSINESS_VERIFICATION: 사업자 인증 관련
- MESSAGE_CAMPAIGN: 메시지 캠페인 관련
- PAYMENT: 결제 관련
- SYSTEM: 시스템 공지
- USER_ACTION: 사용자 액션 관련

### 6.2 실시간 알림 (향후)
- WebSocket 또는 Server-Sent Events 도입 고려
- 현재는 폴링 방식으로 구현

### 6.3 알림 설정
- 사용자별 알림 수신 설정 (이메일, SMS 등)
- 알림 카테고리별 ON/OFF 설정

## 7. 구현 순서

1. **데이터베이스 마이그레이션**
   - notifications, notification_reads 테이블 생성

2. **알림 API 구현**
   - 조회, 읽음 처리, 전송 API

3. **프론트엔드 알림 시스템 구현**
   - Navigation 컴포넌트 수정
   - 알림 Context 생성
   - 폴링 시스템 구현

4. **사업자 인증 연동**
   - 제출 시 관리자 알림 전송

5. **테스트 및 최적화**
   - 알림 전송/수신 테스트
   - 성능 최적화

## 8. 예상 파일 수정 목록

### 8.1 새로 생성할 파일
- `src/app/api/notifications/route.ts` - 알림 조회 API
- `src/app/api/notifications/[id]/read/route.ts` - 알림 읽음 처리
- `src/app/api/notifications/mark-all-read/route.ts` - 전체 읽음 처리
- `src/app/api/notifications/send/route.ts` - 알림 전송 (내부용)
- `src/contexts/NotificationContext.tsx` - 알림 상태 관리
- `src/hooks/useNotifications.ts` - 알림 관련 훅
- `migrations/create_notifications_tables.sql` - 데이터베이스 마이그레이션

### 8.2 수정할 파일
- `src/components/Navigation.tsx` - 실제 데이터 연동
- `src/components/AdminHeader.tsx` - 관리자 헤더 알림 연동
- `src/app/api/business-verification/submit/route.ts` - 알림 전송 로직 추가
- `src/app/my-site/advertiser/business-verification/page.tsx` - UI 개선 (필요시)

## 9. 보안 고려사항

### 9.1 권한 검증
- 알림 조회 시 본인 알림만 조회 가능
- 관리자 알림은 관리자 권한 사용자만 조회

### 9.2 입력 검증
- XSS 방지를 위한 HTML 태그 필터링
- SQL 인젝션 방지

### 9.3 Rate Limiting
- 알림 전송 API에 대한 요청 제한
- 폴링 요청에 대한 적절한 간격 유지

## 10. 모니터링 및 로깅

### 10.1 알림 전송 로그
- 알림 생성/전송 이력 기록
- 실패한 알림에 대한 재시도 메커니즘

### 10.2 성능 모니터링
- 알림 조회 쿼리 성능 모니터링
- 대량 알림 전송 시 성능 최적화

이 계획에 따라 단계적으로 구현하면 확장 가능한 알림 시스템을 구축할 수 있습니다.
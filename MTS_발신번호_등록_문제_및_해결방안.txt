# MTS API 발신번호 등록 문제 및 해결방안

작성일: 2025-10-29
문서 버전: 1.0

================================================================================

## 1️⃣ 현재 발생한 문제

### 문제 증상
- SMS/LMS 발송 시 실패: "성공: 0건, 실패: 1건"
- 오류 코드: ER17
- 오류 메시지: "NotAllowedCallbackNumber (허용되지 않은 발신번호)"

### 테스트 환경
- 발신번호: 010-4057-1331
- 수신번호: 010-4057-1331 (본인)
- 발송 시도: SMS 단문 메시지

### 실제 MTS API 요청/응답

[요청]
{
  "auth_code": "7z12bG8oKXrMnHZcJBtycw==",
  "callback_number": "01040571331",
  "phone_number": "01040571331",
  "message": "[테스트] SMS 단문 발송 테스트입니다."
}

[응답]
{
  "code": "ER17",
  "received_at": "2025-10-29 11:59:06",
  "message": "NotAllowedCallbackNumber"
}

================================================================================

## 2️⃣ 문제 원인

### MTS API 발신번호 정책
MTS API 연동규격서 문서 분석 결과:

1. 발신번호 사전 등록 필수

   ER17 오류 코드 정의:
   "MTS 메시지: 전환전송 사용 시, 사전 승인받은 발신번호가 아닙니다."

   SMS 결과코드표:
   ER17: "MTS 메시지: 사전 승인받은 발신번호가 아닙니다."

2. 문서 원문 명시

   "전환전송을 하도록 요청을 주실 시,
    발신 전화번호는 반드시 사전등록 된 발신번호를 넣어주셔야 합니다."

3. callback_number 파라미터
   - 타입: text(15)
   - 필수: Y (Required)
   - 설명: "발신전화번호"
   - 반드시 MTS 시스템에 사전 등록되어 있어야 함

================================================================================

## 3️⃣ MTS API 문서 조사 결과

### 조사한 문서 (총 9개)

발송API 폴더 (4개):
1. MTS_카카오알림톡_Restful_Interface_Guide_v2.1.md
2. MTS_카카오브랜드메시지_기본형_변수분리방식_Restful_Interface_Guide_v1.1.md
3. MTS_카카오브랜드메시지_기본형_전문방식_Restful_Interface_Guide_v1.0.md
4. MTS_카카오브랜드메시지_자유형_Restful_Interface_Guide_v1.0.md

비즈API 폴더 (5개):
5. 카카오 발신프로필관리 자동화 API v20251002.md
6. 카카오 브랜드메시지 템플릿 API_1.4.md
7. 카카오 알림톡 템플릿 자동화 API 20250801.md
8. 카카오 이미지 업로드 API 20210629.md
9. MTS_네이버스마트알림 템플릿API_1.7.md

### 조사 결과
- ❌ SMS/LMS/MMS 발신번호를 API로 등록하는 방법 없음
- ✅ 카카오 발신프로필 관리 API만 존재 (카카오톡 채널용, SMS와는 별개)
- ✅ SMS/LMS/MMS 발송 API만 존재
- ❌ 발신번호 등록/승인 요청 API 없음

### 확인된 API 목록

[SMS/LMS/MMS 발송]
- POST /sndng/sms/sendMessage (단건)
- POST /sndng/sms/sendMessages (복수, 최대 1000건)
- POST /sndng/mms/sendMessage (단건)
- POST /sndng/mms/sendMessages (복수, 최대 1000건)
- POST /rspns/sms/rspnsMessages (발송 결과 조회)
- POST /rspns/mms/rspnsMessages (발송 결과 조회)
- POST /img/upload_image (MMS 이미지 업로드)

[카카오 발신프로필 - 카카오톡 채널용]
- POST /mts/api/sender/token (인증 토큰 요청)
- POST /mts/api/create/new/senderKey (발신프로필 등록)
- POST /mts/api/select/senderKey (발신프로필 조회)
- POST /mts/api/delete/senderKey (발신프로필 삭제)

================================================================================

## 4️⃣ 해결 방법

### 단기 해결책 (테스트 단계)

#### 옵션 A: MTS 담당자에게 발신번호 등록 요청

요청 내용:
───────────────────────────────────────────────────────────
담당자님,

SMS/LMS/MMS 발송 테스트를 위해 발신번호 등록을 요청드립니다.

- 등록 요청 번호: 010-4057-1331
- 용도: SMS/LMS/MMS 발송 테스트
- 인증코드: 7z12bG8oKXrMnHZcJBtycw==
───────────────────────────────────────────────────────────

#### 옵션 B: 이미 등록된 테스트 번호 확인
- .env.local의 TEST_CALLING_NUMBER 확인
- 해당 번호가 이미 MTS에 등록되어 있는지 확인
- 등록되어 있다면 해당 번호로 테스트

---

### 중장기 해결책 (실제 서비스 운영)

#### 방안 1: 대표 발신번호 방식 (권장 ⭐)

장점:
  ✅ 한 번만 등록하면 모든 사용자가 사용 가능
  ✅ 관리 간편
  ✅ 비용 효율적
  ✅ 대부분의 SMS 서비스가 이 방식 사용

단점:
  ❌ 사용자별 개인 번호 사용 불가

구현:
  - 회사 대표번호 1개를 MTS에 등록 (예: 1588-xxxx, 080-xxx-xxxx)
  - 모든 사용자가 이 번호로 발송
  - 사용자는 로그인만 하면 즉시 발송 가능

---

#### 방안 2: 사용자별 발신번호 방식

장점:
  ✅ 사용자가 자신의 번호로 발송 가능
  ✅ 수신자에게 발신자 신원이 명확

단점:
  ❌ 각 사용자마다 MTS 담당자에게 등록 요청 필요
  ❌ 승인 대기 시간 소요
  ❌ 관리 복잡
  ❌ 확장성 낮음

구현 시나리오:
  1. 사용자 회원가입
  2. 사용자가 발신번호 등록 요청
  3. 시스템이 관리자에게 알림
  4. 관리자가 MTS 담당자에게 등록 요청
  5. MTS 승인 완료 후 사용자에게 알림
  6. 사용자 발송 가능

---

#### 방안 3: 하이브리드 방식
  - 기본: 대표 발신번호 사용
  - 옵션: 사용자가 원하면 개인 번호 등록 (유료 옵션)

================================================================================

## 5️⃣ MTS 담당자 문의 사항

다음 내용을 MTS 담당자에게 확인 필요:

### 질문 1: 발신번호 자동 등록 API

Q: SMS/LMS/MMS 발신번호를 API를 통해 자동으로 등록/승인 요청할 수 있는
   방법이 있나요?

A: (담당자 확인 필요)

---

### 질문 2: 대량 발신번호 등록 프로세스

Q: 서비스 사용자가 늘어날 경우, 대량의 발신번호를 등록하는
   간소화된 프로세스가 있나요?

A: (담당자 확인 필요)

---

### 질문 3: 대표 발신번호 정책

Q: 하나의 대표 발신번호로 여러 사용자가 발송하는 것이 가능한가요?
   발송량 제한이나 정책적 제약사항이 있나요?

A: (담당자 확인 필요)

---

### 질문 4: 테스트 환경

Q: 테스트용 발신번호는 어떻게 등록하나요?
   테스트 환경과 운영 환경의 발신번호가 별도인가요?

A: (담당자 확인 필요)

================================================================================

## 6️⃣ 권장 사항

### 즉시 조치 (테스트 완료를 위해)

1. MTS 담당자에게 연락
   - 발신번호 010-4057-1331 등록 요청
   - 또는 이미 등록된 테스트 번호 확인

2. 등록 완료 후
   - Phase 1-1 (SMS) 테스트
   - Phase 1-2 (LMS) 테스트
   - Phase 1-3 (MMS) 테스트

---

### 서비스 방향 결정 (운영 전략)

1. 방안 1 선택 시 (대표 발신번호 - 권장)
   - 대표번호 1개 등록
   - 발신번호 관리 UI 제거
   - 모든 사용자가 대표번호로 발송

2. 방안 2 선택 시 (사용자별 발신번호)
   - 발신번호 등록 워크플로우 구축
   - 관리자 승인 프로세스 강화
   - 사용자 대기 시간 안내

================================================================================

## 📌 요약

문제:
  발신번호가 MTS 시스템에 사전 등록되지 않아 ER17 오류 발생

원인:
  MTS API는 SMS/LMS/MMS 발송 시 반드시 사전 등록된 발신번호만 허용

해결:
  - 단기: MTS 담당자에게 테스트용 발신번호 등록 요청
  - 장기: 대표 발신번호 1개 등록 후 모든 사용자가 공유 (권장)

확인 사항:
  MTS 담당자에게 발신번호 자동 등록 API 존재 여부 문의

================================================================================

관련 파일:
- docs/연동규격서md/발송API/MTS_카카오알림톡_Restful_Interface_Guide_v2.1.md
- src/lib/mtsApi.ts
- .env.local (TEST_CALLING_NUMBER)

작성자: Claude Code
최종 수정일: 2025-10-29

# 리워드 시스템 데이터베이스 연동 업데이트

## 변경 개요

기존에 더미 데이터를 사용하던 리워드 관리 페이지를 실제 Supabase `transactions` 테이블과 연동하도록 업데이트했습니다. 별도의 정산 테이블 없이 기존 transactions 데이터를 활용하여 동적으로 리워드 통계와 정산 내역을 생성합니다.

## 변경된 파일들

### 1. 새로 추가된 API

- `src/app/api/rewards/route.ts` - 리워드 통계 및 내역 조회 API
- `src/app/api/settlements/route.ts` - 정산 내역 조회 API

### 2. 수정된 파일

- `src/app/salesperson/referrals/page.tsx` - 실제 API와 연동하도록 수정
- `src/lib/api.ts` - 리워드 관련 API 함수 및 타입 정의 추가
- `src/app/globals.css` - 빈 상태 스타일 추가

### 3. 데이터베이스 구조

- **기존 `transactions` 테이블만 사용** - 별도의 정산 테이블 불필요
- 동적 정산 내역 생성으로 실시간 데이터 제공

## 주요 기능

### 1. 리워드 통계 조회

- 총 리워드, 직접/간접 리워드, 월별 리워드, 미지급 리워드 표시
- 실시간 데이터베이스 조회를 통한 정확한 통계

### 2. 리워드 내역 조회

- 직접 추천 리워드 내역
- 간접 추천 리워드 내역 (2차, 3차 등)
- 사용자 정보 마스킹 처리
- 페이지네이션 지원

### 3. 정산 내역 관리

- 월별 동적 정산 계산 (transactions 테이블 기반)
- 실시간 정산 상태 표시 (대기/완료)
- 지난 12개월 정산 내역 동적 생성

## 데이터베이스 설정

### 1. 별도 테이블 설정 불필요

- **추가 테이블 생성 불필요** - 기존 `transactions` 테이블만 사용
- 리워드 데이터가 이미 `transactions` 테이블에 존재

### 2. 필요한 권한 설정

- `SALESPERSON` 역할의 사용자만 리워드 조회 가능
- 기존 `transactions` 테이블의 리워드 데이터 활용
- 동적 정산 계산으로 실시간 데이터 제공

## API 엔드포인트

### 리워드 API (`/api/rewards`)

- `GET /api/rewards?action=stats` - 리워드 통계 조회
- `GET /api/rewards?type=direct&page=1&limit=20` - 직접 추천 리워드 내역
- `GET /api/rewards?type=indirect&page=1&limit=20` - 간접 추천 리워드 내역

### 정산 API (`/api/settlements`)

- `GET /api/settlements` - 정산 내역 조회

## 데이터 흐름

1. **리워드 생성**: 기존 `transactions` API에서 자동으로 처리
2. **리워드 조회**: `rewards` API에서 transactions 테이블을 실시간 조회하여 통계와 내역 제공
3. **정산 처리**: `settlements` API에서 transactions 데이터를 기반으로 월별 정산 내역 동적 생성

## 사용자 인터페이스 개선

- 로딩 상태 표시
- 빈 데이터 상태 처리
- 실시간 데이터 반영
- 한글 날짜/시간 포맷팅
- 사용자 정보 마스킹

## 보안 고려사항

- JWT 토큰 기반 인증
- 영업사원 권한 검증
- 사용자 개인정보 마스킹 처리
- SQL 인젝션 방지

## 향후 개선 사항

1. **실시간 알림**: 새로운 리워드 발생 시 알림
2. **엑셀 다운로드**: 리워드 내역 Excel 다운로드 기능
3. **정산 자동화**: 관리자 승인 없는 자동 정산 처리
4. **대시보드**: 리워드 성과 시각화

## 테스트 방법

1. 영업사원 계정으로 로그인
2. `/salesperson/referrals` 페이지 접속
3. 각 탭(직접 추천, 간접 추천, 정산 내역) 확인
4. 데이터가 올바르게 표시되는지 확인

## 문제 해결

### 데이터가 표시되지 않는 경우

1. 브라우저 콘솔에서 API 오류 확인
2. JWT 토큰 유효성 확인
3. 데이터베이스 연결 상태 확인

### 정산 내역이 없는 경우

1. 리워드 트랜잭션이 `transactions` 테이블에 존재하는지 확인
2. 트랜잭션의 `metadata`에 `rewardLevel` 정보가 올바르게 저장되었는지 확인
3. API 응답에서 동적 정산 계산이 정상 작동하는지 확인

## 배포 전 체크리스트

- [ ] 기존 `transactions` 테이블에 리워드 데이터 존재 확인
- [ ] 환경 변수 확인 (SUPABASE_SERVICE_ROLE_KEY)
- [ ] API 엔드포인트 테스트
- [ ] 사용자 권한 테스트
- [ ] 동적 정산 계산 테스트
- [ ] 에러 처리 테스트

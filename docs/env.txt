================================================================================
                          KG이니시스 환경 설정 및 운영 가이드
================================================================================

📋 목차
1. 환경 변수 설정 (상세)
2. 팝업 차단 해제 가이드
3. 테스트 계정 및 카드 정보
4. 문제 해결 (상세)
5. 운영 배포 체크리스트
6. 개발자 참고사항

================================================================================
1. 환경 변수 설정 (상세)
================================================================================

1.1 .env.local 파일 설정
----------------------------------------

## 기존 TOSS_PAYMENTS 환경 변수 제거 (삭제 완료)
# NEXT_PUBLIC_TOSS_CLIENT_KEY=삭제됨
# TOSS_SECRET_KEY=삭제됨

## KG이니시스 결제 환경 변수 제거 (삭제 완료)
# INICIS_MID=삭제됨
# INICIS_SIGNKEY=삭제됨
# KGINICIS_TEST_MODE=삭제됨
# KGINICIS_API_KEY=삭제됨

## Nice Payments 환경 변수 (새로 추가)
# 테스트 환경 (샌드박스)
NICEPAY_CLIENT_ID=S2_af4543a0be4d49a98122e01ec2059a56
NICEPAY_SECRET_KEY=9eb85607103646da9f9c02b128f2e5ee
NICEPAY_API_URL=https://sandbox-api.nicepay.co.kr
NICEPAY_JS_SDK_URL=https://sandbox-pay.nicepay.co.kr/v1/js/

## 기본 URL 설정 (필수)
NEXT_PUBLIC_BASE_URL=http://localhost:3000

## 기존 환경 변수는 그대로 유지
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
JWT_SECRET=your-jwt-secret
OPENAI_API_KEY=your-openai-key
# ... 기타 기존 환경 변수들

1.2 운영 환경 설정
----------------------------------------
# Nice Payments 실제 상점 정보로 변경
NICEPAY_CLIENT_ID=R1_실제클라이언트아이디
NICEPAY_SECRET_KEY=실제시크릿키
NICEPAY_API_URL=https://api.nicepay.co.kr
NICEPAY_JS_SDK_URL=https://pay.nicepay.co.kr/v1/js/
NEXT_PUBLIC_BASE_URL=https://yourdomain.com

1.3 Nice Payments 테스트 계정 정보 (상세)
----------------------------------------
샌드박스 테스트용:
- Client ID: S2_af4543a0be4d49a98122e01ec2059a56
- Secret Key: 9eb85607103646da9f9c02b128f2e5ee
- API URL: https://sandbox-api.nicepay.co.kr
- JS SDK URL: https://sandbox-pay.nicepay.co.kr/v1/js/
- 샌드박스에서는 실제 승인이 발생하지 않아 편리하게 TEST가 가능합니다.
- 모든 응답값은 임의값이며, resultCode가 0000이면 성공입니다.

1.4 JavaScript SDK URL 설정
----------------------------------------
PaymentModal.tsx에서 스크립트 URL 설정:
- 테스트: https://sandbox-pay.nicepay.co.kr/v1/js/
- 운영: https://pay.nicepay.co.kr/v1/js/

1.5 Nice Payments API 엔드포인트
----------------------------------------
nicepay API에서 사용하는 주요 URL:
- 샌드박스: https://sandbox-api.nicepay.co.kr/v1/payments/{tid}
- 운영: https://api.nicepay.co.kr/v1/payments/{tid}
- 취소 API: /v1/payments/{tid}/cancel
- 조회 API: /v1/payments/{tid}

================================================================================
2. 팝업 차단 해제 가이드 (매우 중요!)
================================================================================

2.1 Chrome 브라우저:
1. 주소창 우측에 팝업 차단 아이콘 클릭
2. "팝업 및 리다이렉트 허용" 선택
3. 또는 설정 > 개인정보 및 보안 > 사이트 설정 > 팝업 및 리다이렉트

2.2 Edge 브라우저:
1. 주소창에서 팝업 차단 표시 클릭
2. "허용" 선택
3. 또는 설정 > 쿠키 및 사이트 권한 > 팝업 및 리다이렉트

2.3 Firefox 브라우저:
1. 주소창 왼쪽 방패 아이콘 클릭
2. "팝업 차단 해제" 선택

2.4 Safari 브라우저:
1. Safari > 환경설정 > 웹사이트
2. "팝업 창" 설정에서 해당 사이트 허용

⚠️ 중요: 팝업 차단이 해제되지 않으면 결제창이 열리지 않습니다!

================================================================================
3. 테스트 계정 및 카드 정보
================================================================================

3.1 추천 테스트 카드:
✅ 신한카드: 모든 기능 테스트 가능
✅ 삼성카드: 일반 결제 테스트 가능
✅ 현대카드: 일반 결제 테스트 가능
✅ 롯데카드: 일반 결제 테스트 가능
✅ 하나카드: 일반 결제 테스트 가능
✅ BC카드: 일반 결제 테스트 가능

3.2 피해야 할 카드:
❌ 국민카드: 정책상 테스트 결제 불가
❌ 카카오뱅크카드: 정책상 테스트 결제 불가

3.3 테스트 결제 주의사항:
- 테스트 결제는 실제 승인됩니다
- 당일 자정 이전에 자동 취소됩니다
- 취소되지 않은 경우 KG이니시스 고객센터에 문의
- 해외카드는 테스트 불가능합니다

================================================================================
4. 문제 해결 (상세)
================================================================================

4.1 결제창이 열리지 않는 경우:
□ **브라우저 팝업 차단 해제** (가장 중요!)
  - Chrome: 주소창 우측 팝업 차단 아이콘 클릭 → 허용
  - Edge: 주소창에서 팝업 차단 표시 클릭 → 허용
□ 환경 변수 설정 확인 (INICIS_MID, INICIS_SIGNKEY)
□ NEXT_PUBLIC_BASE_URL 설정 확인
□ 브라우저 콘솔에서 에러 메시지 확인 (F12)
□ 네트워크 탭에서 API 요청 확인

4.2 결제 승인 실패:
□ MID와 signkey 정확성 확인
□ 결제 금액 형식 확인 (문자열 형태의 숫자)
□ 타임스탬프 동기화 확인
□ 해시 값 생성 로직 확인
□ 네트워크 연결 상태 확인

4.3 크레딧 충전 실패:
□ Supabase 연결 상태 확인
□ 사용자 인증 토큰 확인
□ 데이터베이스 권한 확인
□ transactions 테이블 구조 확인
□ user_balances 테이블 확인

4.4 자주 발생하는 에러와 해결책:
❌ "필수 파라미터가 누락되었습니다" 
   → 환경 변수 미설정 (.env.local 파일 확인)

❌ "승인 URL이 일치하지 않습니다" 
   → idc_name 불일치 (KG이니시스 측 문제)

❌ "결제 승인에 실패했습니다" 
   → signkey 또는 해시 값 오류

❌ 팝업이 차단됨 
   → 브라우저 설정에서 팝업 허용 필요

❌ "KG이니시스 스크립트 로드 실패"
   → 네트워크 연결 확인, CORS 설정 확인

4.5 디버깅 방법:
1. 브라우저 개발자 도구 열기 (F12)
2. Console 탭에서 에러 메시지 확인
3. Network 탭에서 API 요청/응답 확인
4. 서버 콘솔에서 로그 확인 (npm run dev)

4.6 로그 확인 방법:
- 클라이언트 에러: 브라우저 F12 → Console 탭
- API 에러: 터미널의 npm run dev 로그
- 네트워크 에러: 브라우저 F12 → Network 탭
- Supabase 에러: Supabase 대시보드 로그

================================================================================
5. 운영 배포 체크리스트
================================================================================

5.1 개발 환경 설정 체크리스트:
□ package.json에서 @tosspayments/tosspayments-sdk 제거 확인
□ npm install 실행 완료
□ .env.local에 KG이니시스 환경 변수 추가 완료
□ 기존 Toss Payments 환경 변수 제거 완료
□ 로컬 서버 정상 실행 (npm run dev)
□ PaymentModal이 KG이니시스 버전으로 교체 확인

5.2 테스트 체크리스트:
□ 브라우저 팝업 차단 해제 완료
□ credit-management 페이지 접속 가능
□ 결제 모달이 4단계로 정상 작동
□ "🚀 결제창 열기" 버튼 클릭 시 새 창 열림
□ KG이니시스 결제창에서 테스트 결제 성공
□ 크레딧 충전 정상 작동 확인
□ 결제 성공 페이지로 리다이렉트 확인

5.3 운영 배포 체크리스트:
□ 실제 상점 MID와 signkey로 변경
□ NEXT_PUBLIC_BASE_URL을 실제 도메인으로 변경
□ PaymentModal.tsx에서 운영 JS SDK URL로 변경
□ HTTPS 인증서 적용
□ 운영 환경에서 테스트 결제 확인
□ 에러 모니터링 설정

5.4 보안 체크리스트:
□ signkey가 클라이언트에 노출되지 않는지 확인
□ HTTPS 인증서 정상 작동 확인
□ CORS 설정 확인
□ API 엔드포인트 보안 확인
□ 환경 변수 암호화 확인

5.5 성능 체크리스트:
□ JavaScript SDK 로딩 시간 확인
□ 결제창 응답 시간 확인
□ API 응답 시간 확인
□ 데이터베이스 쿼리 최적화 확인

================================================================================
6. 개발자 참고사항
================================================================================

6.1 중요한 변경사항:
- ✅ PaymentModal.tsx가 완전히 새로 작성되었습니다.
- ✅ KG이니시스 JavaScript SDK 방식을 사용합니다.
- ✅ 4단계 결제 플로우 구현 (패키지 확인 → 결제 방법 선택 → 결제창 열기 → 처리 중)
- ✅ TypeScript 타입 정의 추가
- ✅ 팝업 차단 해제 안내 강화
- ❌ Toss Payments 관련 코드가 모두 제거되었습니다.

6.2 기술적 고려사항:
- KG이니시스 개발 문서: https://docs.inicis.com/
- 테스트 결제는 당일 자정에 자동 취소됩니다.
- 결제 보안을 위해 서버사이드에서 해시 검증을 수행합니다.
- 결제 승인은 비동기적으로 처리되므로 적절한 로딩 상태를 제공합니다.
- 국민카드는 정책상 테스트 결제가 불가능합니다.
- 운영 환경에서는 반드시 HTTPS를 사용해야 합니다.
- JavaScript SDK는 동적으로 로드되므로 네트워크 상태가 중요합니다.

6.3 아키텍처 정보:
- 결제 플로우: PaymentModal → inicis/request → KG이니시스 JS SDK → 결제창 → inicis/return → confirm → success
- 보안: SHA256 해시 검증, 서버사이드 승인 처리
- 핵심 요구사항: 브라우저 팝업 차단 해제 필수

6.4 운영 시 주의사항:
- SSL 인증서: 운영 환경에서는 반드시 HTTPS 사용 필요
- 팝업 정책: 사용자에게 팝업 차단 해제 안내 필수
- 카드 제한: 국민카드, 카카오뱅크카드 테스트 불가
- 자동 취소: 테스트 결제는 당일 자정에 자동 취소

6.5 모니터링 포인트:
- JavaScript SDK 로딩 실패
- 팝업 차단으로 인한 결제창 오픈 실패
- 해시 검증 실패
- 승인 API 호출 실패
- 크레딧 충전 실패

================================================================================
📞 긴급 지원 및 문의
================================================================================

KG이니시스 관련 문의:
- 기술 지원: KG이니시스 개발자 센터 (https://docs.inicis.com/)
- 상점 계약: KG이니시스 영업팀 (1588-7722)
- 가맹점 관리자: https://iniweb.inicis.com/

긴급 문제 해결 순서:
1. 🔴 브라우저 팝업 차단 해제 먼저 시도
2. 🟡 F12 콘솔에서 에러 메시지 확인
3. 🟡 환경 변수 설정 재확인
4. 🟡 개발자 도구 Network 탭에서 API 응답 확인
5. 🟢 개발팀 내부 문의 채널 이용

================================================================================
📈 최신 업데이트 정보
================================================================================

버전: 3.0 (KG이니시스 완전 통합 버전)
작성일: 2024년
최종 업데이트: PaymentModal.tsx 완전 재작성 완료

주요 변경사항:
✅ PaymentModal.tsx 완전히 새로 작성 (KG이니시스 전용)
✅ JavaScript SDK 방식으로 구현
✅ 4단계 결제 플로우 구현
✅ TypeScript 타입 정의 추가
✅ 팝업 차단 해제 안내 강화
✅ 에러 처리 및 사용자 경험 개선

이제 KG이니시스 결제 시스템이 완전히 구축되었습니다! 🎉

================================================================================ 
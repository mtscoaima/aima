================================================================================
                      KG이니시스 결제 시스템 완전 가이드
================================================================================

📋 목차
1. 개요
2. 환경 변수 설정
3. 시스템 구성
4. 결제 플로우
5. API 엔드포인트
6. 테스트 방법
7. 운영 환경 적용
8. 문제 해결
9. 주요 변경사항

================================================================================
1. 개요
================================================================================

이 프로젝트에서 기존 Toss Payments 결제 시스템을 KG이니시스로 변경했습니다.

주요 특징:
- 안전한 결제창 방식 (새 창/iframe)
- 다양한 결제 수단 지원 (카드, 계좌이체, 가상계좌 등)
- 테스트/운영 환경 분리
- 기존 결제 플로우와 호환성 유지
- SHA256 해시 기반 보안 검증

================================================================================
2. 환경 변수 설정
================================================================================

2.1 .env.local 파일 설정
----------------------------------------

## 기존 TOSS_PAYMENTS 환경 변수 제거 (삭제 필요)
# NEXT_PUBLIC_TOSS_CLIENT_KEY=삭제
# TOSS_SECRET_KEY=삭제

## KG이니시스 환경 변수 추가
# 테스트 환경
INICIS_MID=INIpayTest
INICIS_SIGNKEY=SU5JTElURV9UUklQTEVERVNfS0VZU1RS

## 기본 URL 설정 (필수)
NEXT_PUBLIC_BASE_URL=http://localhost:3000

## 기존 환경 변수는 그대로 유지
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
JWT_SECRET=your-jwt-secret
OPENAI_API_KEY=your-openai-key
# ... 기타 기존 환경 변수들

2.2 운영 환경 설정
----------------------------------------
# KG이니시스 실제 상점 정보로 변경
INICIS_MID=실제상점아이디
INICIS_SIGNKEY=실제사인키
NEXT_PUBLIC_BASE_URL=https://yourdomain.com

2.3 KG이니시스 테스트 계정 정보
----------------------------------------
- 테스트 MID: INIpayTest (일반결제)
- signkey: SU5JTElURV9UUklQTEVERVNfS0VZU1RS
- 테스트 결제는 실 승인되며 당일 자정 이전에 자동 취소됩니다.
- 국민카드, 카카오뱅크카드는 테스트 불가하니 다른 카드로 테스트하세요.

2.4 추가 테스트 계정 (참고용)
----------------------------------------
빌링/정기과금용:
- 테스트 MID: INIBillTst
- signkey: SU5JTElURV9UUklQTEVERVNfS0VZU1RS
- INIAPI key: rKnPljRn5m6J9Mzz
- INIAPI iv: W2KLNKra6Wxc1P==

================================================================================
3. 시스템 구성
================================================================================

3.1 새로 생성된 파일:
- src/app/api/payment/inicis/request/route.ts    (결제 요청 API)
- src/app/api/payment/inicis/return/route.ts     (결제 완료 처리 API)
- src/app/payment/close/page.tsx                 (결제창 닫기 페이지)

3.2 수정된 파일:
- src/components/PaymentModal.tsx                (결제 모달 컴포넌트)
- src/app/api/payment/confirm/route.ts           (결제 승인 API)
- package.json                                   (toss-payments 의존성 제거)

3.3 제거된 의존성:
- @tosspayments/tosspayments-sdk

================================================================================
4. 결제 플로우
================================================================================

4.1 사용자 결제 과정:
1. 사용자가 크레딧 패키지 선택
2. PaymentModal에서 결제 정보 확인 (3단계)
   - 1단계: 패키지 확인
   - 2단계: 결제 방법 선택 (KG이니시스)
   - 3단계: 결제창 열기
3. KG이니시스 결제 요청 API 호출 (/api/payment/inicis/request)
4. 새 창에서 KG이니시스 결제창 열림
5. 사용자가 결제 진행 (카드/계좌이체/가상계좌 등)
6. 결제 완료 시 /api/payment/inicis/return으로 콜백
7. 자동으로 KG이니시스 승인 API 호출
8. 자동으로 /api/payment/confirm 호출하여 크레딧 충전
9. /payment/success 페이지로 리다이렉트

4.2 기술적 플로우:
PaymentModal → inicis/request → KG이니시스 결제창 → inicis/return → confirm → success

4.3 보안 처리:
- SHA256 해시를 이용한 거래 검증
- 서버사이드 승인 처리
- FormData 기반 안전한 데이터 전송

================================================================================
5. API 엔드포인트
================================================================================

5.1 POST /api/payment/inicis/request
목적: KG이니시스 결제 요청 데이터 생성
요청 파라미터:
- price: 결제 금액 (string)
- goodname: 상품명
- buyername: 구매자명
- buyertel: 구매자 전화번호 (11자리)
- buyeremail: 구매자 이메일
- oid: 주문번호

응답:
- paymentForm: KG이니시스 결제 폼 데이터 (암호화된 해시 포함)

5.2 POST /api/payment/inicis/return
목적: KG이니시스 결제 완료 후 승인 처리
요청: KG이니시스에서 FormData로 전송
처리 과정:
1. resultCode 확인 (0000 = 성공)
2. KG이니시스 승인 API 호출
3. 자동으로 /api/payment/confirm 호출
4. 성공 시 /payment/success로 리다이렉트
5. 실패 시 /payment/fail로 리다이렉트

5.3 POST /api/payment/confirm (수정됨)
목적: 결제 승인 및 크레딧 충전
변경사항: 
- KG이니시스 결제 데이터 처리 방식으로 수정
- paymentData 파라미터 추가
- method 필드 "inicis"로 설정

5.4 GET /payment/close
목적: KG이니시스 결제창 닫기
기능: INIStdPay_close.js 스크립트 자동 실행

================================================================================
6. 테스트 방법
================================================================================

6.1 로컬 환경 설정:
1. 환경 변수 설정 (.env.local):
   INICIS_MID=INIpayTest
   INICIS_SIGNKEY=SU5JTElURV9UUklQTEVERVNfS0VZU1RS
   NEXT_PUBLIC_BASE_URL=http://localhost:3000

2. 서버 실행:
   npm run dev

6.2 테스트 진행:
1. 크레딧 충전 페이지 접속 (http://localhost:3000/credit-management)
2. 패키지 선택 후 "크레딧 충전" 클릭
3. 결제 모달에서 "결제하기" 클릭
4. "결제창 열기" 클릭
5. KG이니시스 결제창에서 테스트 카드로 결제
   - 추천 테스트 카드: 신한, 삼성, 현대, 롯데, 하나 등
   - 피해야 할 카드: 국민카드, 카카오뱅크카드
6. 결제 완료 후 성공 페이지 확인

6.3 팝업 차단 해제:
- 브라우저에서 팝업 차단을 해제해야 결제창이 정상 작동합니다.
- Chrome: 주소창 우측 팝업 차단 아이콘 클릭 → 허용

6.4 테스트 결과 확인:
- 결제는 실제 승인되며 당일 자정에 자동 취소됩니다.
- 크레딧이 정상적으로 충전되는지 확인
- 트랜잭션 내역이 올바르게 기록되는지 확인

================================================================================
7. 운영 환경 적용
================================================================================

7.1 상점 정보 변경:
1. KG이니시스에서 실제 상점 계약 체결
2. 환경 변수를 실제 MID와 signkey로 변경:
   INICIS_MID=실제상점아이디
   INICIS_SIGNKEY=실제사인키
   NEXT_PUBLIC_BASE_URL=https://yourdomain.com

7.2 코드 변경 (PaymentModal.tsx):
결제창 URL을 운영용으로 변경:
- 테스트: https://stgstdpay.inicis.com/stdpay/pay
- 운영: https://stdpay.inicis.com/stdpay/pay

form.action = 'https://stdpay.inicis.com/stdpay/pay'; // 운영 환경

7.3 승인 URL 자동 처리:
inicis/return/route.ts에서 idc_name에 따라 자동으로 운영 URL 사용:
- fc: https://fcstdpay.inicis.com/api/payAuth
- ks: https://ksstdpay.inicis.com/api/payAuth
- default: https://stdpay.inicis.com/api/payAuth

7.4 SSL 인증서:
- 운영 환경에서는 반드시 HTTPS 사용 필요
- KG이니시스 정책상 HTTP는 지원하지 않음

================================================================================
8. 문제 해결
================================================================================

8.1 결제창이 열리지 않는 경우:
□ 팝업 차단 설정 확인
□ 환경 변수 설정 확인 (INICIS_MID, INICIS_SIGNKEY)
□ NEXT_PUBLIC_BASE_URL 설정 확인
□ 브라우저 콘솔에서 에러 메시지 확인
□ 네트워크 탭에서 API 요청 확인

8.2 결제 승인 실패:
□ MID와 signkey 정확성 확인
□ 결제 금액 형식 확인 (문자열 형태의 숫자)
□ 타임스탬프 동기화 확인
□ 해시 값 생성 로직 확인
□ 네트워크 연결 상태 확인

8.3 크레딧 충전 실패:
□ Supabase 연결 상태 확인
□ 사용자 인증 토큰 확인
□ 데이터베이스 권한 확인
□ 트랜잭션 테이블 구조 확인
□ user_balances 테이블 확인

8.4 일반적인 에러 해결:
□ 서버 로그 확인: npm run dev 콘솔
□ 브라우저 개발자 도구 네트워크 탭 확인
□ 환경 변수 누락 여부 확인
□ CORS 설정 확인 (운영 환경)

8.5 자주 발생하는 에러:
- "필수 파라미터가 누락되었습니다" → 환경 변수 미설정
- "승인 URL이 일치하지 않습니다" → idc_name 불일치
- "결제 승인에 실패했습니다" → signkey 또는 해시 값 오류
- 팝업 차단 → 브라우저 설정 변경 필요

================================================================================
9. 주요 변경사항
================================================================================

9.1 제거된 기능:
× Toss Payments SDK 의존성
× Toss Payments 위젯 시스템
× Toss Payments API 호출
× 토스페이먼츠 클라이언트 키 설정

9.2 새로 추가된 기능:
✓ KG이니시스 결제창 연동
✓ SHA256 해시 기반 보안 검증
✓ 동적 결제 폼 생성
✓ 자동 결제 승인 처리
✓ Form 기반 결제 요청

9.3 유지된 기능:
✓ 기존 UI/UX 플로우
✓ 크레딧 충전 로직
✓ 사용자 인증 시스템
✓ 결제 성공/실패 페이지
✓ 트랜잭션 관리 시스템

9.4 개선된 부분:
✓ 더 안전한 결제 처리
✓ 다양한 결제 수단 지원
✓ 명확한 에러 처리
✓ 테스트/운영 환경 분리

================================================================================
🔧 개발자 참고사항
================================================================================

- KG이니시스 API 문서: https://docs.inicis.com/
- 테스트 결제는 당일 자정에 자동 취소됩니다.
- 결제 보안을 위해 서버사이드에서 해시 검증을 수행합니다.
- 결제 승인은 비동기적으로 처리되므로 적절한 로딩 상태를 제공합니다.
- 국민카드는 정책상 테스트 결제가 불가능합니다.
- 운영 환경에서는 반드시 HTTPS를 사용해야 합니다.

================================================================================
📞 지원 및 문의
================================================================================

KG이니시스 관련 문의:
- 기술 지원: KG이니시스 개발자 센터 (https://docs.inicis.com/)
- 상점 계약: KG이니시스 영업팀 (1588-7722)
- 가맹점 관리자: https://iniweb.inicis.com/

시스템 관련 문의:
- 개발팀 내부 문의 채널 이용
- GitHub Issues 등록

================================================================================
📈 체크리스트
================================================================================

설정 완료 체크리스트:
□ package.json에서 @tosspayments/tosspayments-sdk 제거
□ npm install 실행
□ .env.local에 KG이니시스 환경 변수 추가
□ 기존 Toss Payments 환경 변수 제거
□ 로컬 테스트 결제 성공 확인
□ 크레딧 충전 정상 작동 확인

운영 배포 체크리스트:
□ 실제 상점 MID와 signkey로 변경
□ NEXT_PUBLIC_BASE_URL을 실제 도메인으로 변경
□ PaymentModal.tsx에서 운영 URL로 변경
□ HTTPS 인증서 적용
□ 운영 환경에서 테스트 결제 확인

================================================================================
버전: 2.0 (통합 버전)
작성일: 2024년
최종 업데이트: KG이니시스 결제 시스템 완전 가이드 통합
================================================================================